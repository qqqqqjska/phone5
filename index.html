<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packed App</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        iframe { border: none; width: 100%; height: 100%; display: block; }
    </style>
</head>
<body>
    <iframe id="app-frame" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"></iframe>
    <script>
        (function() {
            const VFS = {"小手机/index.html":"<html lang=\"zh-CN\"><head>\n    <meta charset=\"UTF-8\">\n    <title>iPhone Simulator</title>\n    \n    <!-- 基本配置 -->\n    <meta name=\"theme-color\" content=\"#000000\">\n    \n    <!-- iOS全屏配置 -->\n    <meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\n    <meta name=\"apple-mobile-web-app-status-bar-style\" content=\"black-translucent\">\n    <meta name=\"apple-mobile-web-app-title\" content=\"iPhone Simulator\">\n    \n    <!-- 优化视口配置 -->\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover\">\n    \n    <!-- 图标配置 -->\n    <link rel=\"apple-touch-icon\" href=\"https://i.postimg.cc/DZHdV88x/chan-135.png\">\n    <link rel=\"apple-touch-icon\" sizes=\"152x152\" href=\"https://i.postimg.cc/DZHdV88x/chan-135.png\">\n    <link rel=\"apple-touch-icon\" sizes=\"180x180\" href=\"https://i.postimg.cc/DZHdV88x/chan-135.png\">\n    \n    <!-- 对于iOS 15+，添加主题颜色适配 -->\n    <meta name=\"theme-color\" content=\"#000000\" media=\"(prefers-color-scheme: light)\">\n    <meta name=\"theme-color\" content=\"#000000\" media=\"(prefers-color-scheme: dark)\">\n    \n    <!-- Web App Manifest -->\n    <link rel=\"manifest\" href=\"manifest.json\">\n    \n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\">\n    <style>:root {\r\n    --bg-color: #f2f2f7;\r\n    --card-bg: #ffffff;\r\n    --text-primary: #000000;\r\n    --text-secondary: #8e8e93;\r\n    --dock-bg: rgba(255, 255, 255, 0.45);\r\n    --icon-radius: 14px;\r\n    --app-icon-size: 60px;\r\n    --dock-icon-size: 64px;\r\n    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);\r\n    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);\r\n    \r\n    /* Theme Variables */\r\n    --font-family: -apple-system, BlinkMacSystemFont, \"San Francisco\", \"Helvetica Neue\", Helvetica, Arial, sans-serif;\r\n    --wallpaper: none;\r\n    --wallpaper-size: cover;\r\n    \r\n    /* App Colors */\r\n    --color-envelope: #007AFF;\r\n    --color-wechat: #07C160;\r\n    --color-world: #5856D6;\r\n    --color-settings: #8E8E93;\r\n    --color-theme: #FF2D55;\r\n    --color-shopping: #FF9500;\r\n    --color-forum: #30B0C7;\r\n    --color-phone: #34C759;\r\n    \r\n    /* WeChat Colors */\r\n    --wechat-green: #07C160;\r\n    --wechat-bg: #ededed;\r\n    --wechat-header-bg: #f7f7f7;\r\n    --wechat-border: #dcdcdc;\r\n    --wechat-link: #576b95;\r\n}\r\n\r\n/* ====================\r\n   iOS PWA全屏适配\r\n   ==================== */\r\n\r\n/* 1. 基础全屏配置 */\r\nhtml {\r\n  margin: 0;\r\n  padding: 0;\r\n  width: 100%;\r\n  height: 100%;\r\n  overflow: hidden;\r\n  position: fixed; /* 防止整体页面滚动 */\r\n}\r\n\r\nbody {\r\n  margin: 0;\r\n  padding: 0;\r\n  width: 100%;\r\n  height: 100%;\r\n  overflow: hidden;\r\n  position: fixed; /* 防止整体页面滚动 */\r\n  background-color: #000; /* 防止刘海区域透出白色 */\r\n}\r\n\r\n/* 2. iOS Safari全屏适配 */\r\n@supports (-webkit-touch-callout: none) {\r\n  html, body {\r\n    height: -webkit-fill-available;\r\n  }\r\n  \r\n  /* 如果应用有主容器，比如.phone-screen */\r\n  .screen-container, \r\n  .app-screen, \r\n  .sub-screen {\r\n    height: 100%; /* 继承 body 高度 */\r\n  }\r\n}\r\n\r\n/* 3. 安全区域适配（iPhone X以上机型） */\r\nbody {\r\n  padding-top: env(safe-area-inset-top);\r\n  padding-bottom: env(safe-area-inset-bottom);\r\n  padding-left: env(safe-area-inset-left);\r\n  padding-right: env(safe-area-inset-right);\r\n  box-sizing: border-box;\r\n}\r\n\r\n/* 4. 固定底部导航栏适配（如果有的话） */\r\n.dock-bar, .wechat-tab-bar {\r\n  padding-bottom: env(safe-area-inset-bottom);\r\n  /* 确保在安全区域之上 */\r\n  margin-bottom: calc(env(safe-area-inset-bottom) + 10px); \r\n}\r\n\r\n/* 5. 顶部导航栏适配（如果有的话） */\r\n.status-bar {\r\n  padding-top: env(safe-area-inset-top);\r\n  height: calc(47px + env(safe-area-inset-top));\r\n}\r\n\r\n.app-header, .wechat-header, .chat-header {\r\n  padding-top: env(safe-area-inset-top);\r\n  height: calc(44px + env(safe-area-inset-top));\r\n}\r\n\r\n/* 6. 确保内容不被安全区域遮挡 */\r\n.app-body, .wechat-body, .chat-body {\r\n  padding-bottom: max(20px, env(safe-area-inset-bottom));\r\n  overflow: auto;\r\n  -webkit-overflow-scrolling: touch;\r\n}\r\n\r\n/* 7. 全屏页面样式 */\r\n.app-screen, .sub-screen {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  overflow: hidden; /* 内部滚动 */\r\n  -webkit-overflow-scrolling: touch;\r\n}\r\n\r\n* {\r\n    box-sizing: border-box;\r\n    margin: 0;\r\n    padding: 0;\r\n    -webkit-tap-highlight-color: transparent;\r\n    user-select: none;\r\n}\r\n\r\nbody {\r\n    font-family: var(--font-family);\r\n    background-color: #e5e5e5;\r\n    display: block; /* 改为 block，移除 flex 居中 */\r\n    margin: 0;\r\n    padding: 0;\r\n    min-height: 100vh;\r\n    color: var(--text-primary);\r\n}\r\n\r\n/* 屏幕容器 */\r\n.screen-container {\r\n    width: 100%;\r\n    height: 100%; /* 改为 100% 以适应 fixed body */\r\n    background-color: var(--bg-color);\r\n    background-image: var(--wallpaper);\r\n    background-size: var(--wallpaper-size);\r\n    background-position: center;\r\n    position: relative;\r\n    overflow: hidden;\r\n    display: flex;\r\n    flex-direction: column;\r\n}\r\n\r\n/* 状态栏 */\r\n.status-bar {\r\n    /* height: 47px;  已在上方适配 */\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: flex-end;\r\n    padding: 0 24px 10px;\r\n    font-size: 14px;\r\n    font-weight: 600;\r\n    color: #000;\r\n    z-index: 10;\r\n}\r\n\r\n.status-icons {\r\n    display: flex;\r\n    gap: 6px;\r\n    font-size: 12px;\r\n}\r\n\r\n/* 顶部区域 */\r\n.top-section {\r\n    padding: 20px 20px 10px;\r\n    display: flex;\r\n    justify-content: center;\r\n    margin-bottom: 20px;\r\n}\r\n\r\n.profile-container {\r\n    position: relative;\r\n    width: 100%;\r\n    display: flex;\r\n    flex-direction: column;\r\n    align-items: center;\r\n    padding-top: 40px; /* 为头像留出空间 */\r\n}\r\n\r\n.avatar {\r\n    width: 80px;\r\n    height: 80px;\r\n    border-radius: 50%;\r\n    overflow: hidden;\r\n    border: 3px solid #fff;\r\n    box-shadow: var(--shadow-md);\r\n    z-index: 2;\r\n    position: absolute;\r\n    top: 0;\r\n    background-color: #fff;\r\n}\r\n\r\n.avatar img {\r\n    width: 100%;\r\n    height: 100%;\r\n    object-fit: cover;\r\n}\r\n\r\n.profile-card-bg {\r\n    background-color: var(--card-bg);\r\n    width: 120px; /* 略大于头像 */\r\n    padding: 50px 15px 15px; /* 顶部padding为头像留位 */\r\n    border-radius: 20px;\r\n    box-shadow: var(--shadow-sm);\r\n    text-align: center;\r\n    display: flex;\r\n    flex-direction: column;\r\n    align-items: center;\r\n    justify-content: center;\r\n}\r\n\r\n.user-info h2 {\r\n    font-size: 16px;\r\n    font-weight: 600;\r\n    margin-bottom: 4px;\r\n}\r\n\r\n.user-info p {\r\n    font-size: 12px;\r\n    color: var(--text-secondary);\r\n}\r\n\r\n/* 主要内容区域 */\r\n.main-content {\r\n    flex: 1;\r\n    display: flex;\r\n    padding: 0 20px;\r\n    gap: 20px;\r\n    align-items: flex-start;\r\n}\r\n\r\n/* 左侧区域 */\r\n.left-area {\r\n    flex: 1;\r\n    display: flex;\r\n    justify-content: center;\r\n    padding-top: 20px;\r\n}\r\n\r\n/* 右侧区域 */\r\n.right-area {\r\n    flex: 1.5;\r\n}\r\n\r\n.app-grid {\r\n    display: grid;\r\n    grid-template-columns: repeat(2, 1fr);\r\n    gap: 20px 15px;\r\n}\r\n\r\n/* 应用图标通用样式 */\r\n.app-item {\r\n    display: flex;\r\n    flex-direction: column;\r\n    align-items: center;\r\n    gap: 6px;\r\n    cursor: pointer;\r\n    transition: transform 0.2s ease;\r\n}\r\n\r\n.app-item:active {\r\n    transform: scale(0.9);\r\n    opacity: 0.7;\r\n}\r\n\r\n.app-icon {\r\n    width: var(--app-icon-size);\r\n    height: var(--app-icon-size);\r\n    border-radius: var(--icon-radius);\r\n    display: flex;\r\n    justify-content: center;\r\n    align-items: center;\r\n    color: white;\r\n    font-size: 28px;\r\n    box-shadow: var(--shadow-sm);\r\n}\r\n\r\n.app-label {\r\n    font-size: 12px;\r\n    color: var(--text-primary);\r\n    text-align: center;\r\n    font-weight: 500;\r\n}\r\n\r\n/* 特定图标颜色 */\r\n.icon-envelope { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); background-color: var(--color-envelope); }\r\n.icon-wechat { background-color: var(--color-wechat); }\r\n.icon-world { background-color: var(--color-world); }\r\n.icon-settings { background-color: var(--color-settings); }\r\n.icon-theme { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); background-color: var(--color-theme); }\r\n\r\n/* 左侧大图标特殊处理 */\r\n.large-item .app-icon {\r\n    width: 70px;\r\n    height: 70px;\r\n    font-size: 32px;\r\n}\r\n\r\n/* 底部Dock栏 */\r\n.dock-bar {\r\n    margin: 15px;\r\n    margin-bottom: 34px; /* Home indicator space */\r\n    background-color: var(--dock-bg);\r\n    backdrop-filter: blur(20px);\r\n    -webkit-backdrop-filter: blur(20px);\r\n    border-radius: 35px;\r\n    padding: 18px 20px;\r\n    display: flex;\r\n    justify-content: center;\r\n}\r\n\r\n.dock-container {\r\n    display: flex;\r\n    justify-content: space-between;\r\n    width: 100%;\r\n    max-width: 300px;\r\n    gap: 20px;\r\n}\r\n\r\n.dock-item .app-icon {\r\n    width: var(--dock-icon-size);\r\n    height: var(--dock-icon-size);\r\n    font-size: 30px;\r\n}\r\n\r\n.dock-item .app-label {\r\n    display: none; \r\n}\r\n\r\n/* Dock图标颜色 */\r\n.icon-shopping { background-color: var(--color-shopping); }\r\n.icon-forum { background-color: var(--color-forum); }\r\n.icon-phone { background-color: var(--color-phone); }\r\n\r\n/* Home Indicator */\r\n.home-indicator {\r\n    position: absolute;\r\n    bottom: 8px;\r\n    left: 50%;\r\n    transform: translateX(-50%);\r\n    width: 134px;\r\n    height: 5px;\r\n    background-color: #000;\r\n    border-radius: 100px;\r\n    opacity: 0.8;\r\n    z-index: 200;\r\n}\r\n\r\n/* 响应式调整 */\r\n@media (max-height: 700px) {\r\n    .top-section {\r\n        margin-bottom: 10px;\r\n    }\r\n    .profile-container {\r\n        padding-top: 30px;\r\n    }\r\n    .avatar {\r\n        width: 70px;\r\n        height: 70px;\r\n    }\r\n    .profile-card-bg {\r\n        padding-top: 40px;\r\n    }\r\n}\r\n\r\n/* App Screen Styles */\r\n.app-screen {\r\n    position: absolute;\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    background-color: #f2f2f7;\r\n    z-index: 100;\r\n    display: flex;\r\n    flex-direction: column;\r\n    transition: transform 0.3s ease;\r\n}\r\n\r\n.app-screen.hidden {\r\n    transform: translateX(100%);\r\n    pointer-events: none;\r\n}\r\n\r\n.app-header {\r\n    height: 44px;\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n    padding: 0 10px;\r\n    background-color: rgba(255, 255, 255, 0.9);\r\n    backdrop-filter: blur(10px);\r\n    border-bottom: 1px solid rgba(0,0,0,0.1);\r\n    z-index: 10;\r\n}\r\n\r\n.app-header h3 {\r\n    font-size: 17px;\r\n    font-weight: 600;\r\n}\r\n\r\n.back-btn {\r\n    background: none;\r\n    border: none;\r\n    color: #007AFF;\r\n    font-size: 17px;\r\n    display: flex;\r\n    align-items: center;\r\n    gap: 5px;\r\n    cursor: pointer;\r\n    padding: 5px;\r\n}\r\n\r\n.app-body {\r\n    flex: 1;\r\n    overflow-y: auto;\r\n    padding: 20px 16px;\r\n}\r\n\r\n/* iOS List Group Style */\r\n.section-title {\r\n    font-size: 13px;\r\n    color: #6d6d72;\r\n    margin-bottom: 8px;\r\n    margin-left: 16px;\r\n    text-transform: uppercase;\r\n}\r\n\r\n.ios-list-group {\r\n    background-color: #fff;\r\n    border-radius: 10px;\r\n    overflow: hidden;\r\n    margin-bottom: 25px;\r\n}\r\n\r\n.list-item {\r\n    padding: 12px 16px;\r\n    border-bottom: 1px solid #e5e5ea;\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: space-between;\r\n}\r\n\r\n.list-item:last-child {\r\n    border-bottom: none;\r\n}\r\n\r\n.list-item.no-padding {\r\n    padding: 0;\r\n}\r\n\r\n.list-item.center-content {\r\n    justify-content: center;\r\n    cursor: pointer;\r\n}\r\n\r\n.list-item.center-content:active {\r\n    background-color: #f2f2f7;\r\n}\r\n\r\n.list-content {\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: space-between;\r\n    width: 100%;\r\n}\r\n\r\n.list-content.column {\r\n    flex-direction: column;\r\n    align-items: flex-start;\r\n    gap: 10px;\r\n}\r\n\r\n.list-content label {\r\n    font-size: 17px;\r\n    color: #000;\r\n}\r\n\r\n/* Inputs & Buttons */\r\n.file-input-hidden {\r\n    display: none;\r\n}\r\n\r\n.ios-btn {\r\n    color: #007AFF;\r\n    font-size: 17px;\r\n    cursor: pointer;\r\n}\r\n\r\n.ios-btn-small {\r\n    padding: 6px 12px;\r\n    background-color: #007AFF;\r\n    color: white;\r\n    border: none;\r\n    border-radius: 6px;\r\n    font-size: 14px;\r\n    cursor: pointer;\r\n}\r\n\r\n.ios-btn-small.danger {\r\n    background-color: #FF3B30;\r\n}\r\n\r\n.ios-btn-block {\r\n    width: 100%;\r\n    padding: 12px;\r\n    background-color: #007AFF;\r\n    color: white;\r\n    border: none;\r\n    border-radius: 10px;\r\n    font-size: 17px;\r\n    font-weight: 600;\r\n    cursor: pointer;\r\n    margin-bottom: 10px;\r\n}\r\n\r\n.ios-btn-block:last-child {\r\n    margin-bottom: 0;\r\n}\r\n\r\n.ios-btn-block.secondary {\r\n    background-color: #e5e5ea;\r\n    color: #007AFF;\r\n}\r\n\r\n.file-label {\r\n    display: block;\r\n    text-align: center;\r\n}\r\n\r\n.danger-text {\r\n    color: #FF3B30;\r\n    font-size: 17px;\r\n}\r\n\r\n.input-row.full-width {\r\n    width: 100%;\r\n    display: flex;\r\n    gap: 10px;\r\n}\r\n\r\n.button-row.full-width {\r\n    width: 100%;\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: 10px;\r\n}\r\n\r\ninput[type=\"text\"], input[type=\"password\"], select {\r\n    flex: 1;\r\n    padding: 8px;\r\n    border: 1px solid #e5e5ea;\r\n    border-radius: 6px;\r\n    font-size: 16px;\r\n    background-color: #f2f2f7;\r\n    margin: 0;\r\n}\r\n\r\ntextarea {\r\n    width: 100%;\r\n    height: 150px;\r\n    padding: 10px;\r\n    border: none;\r\n    font-family: monospace;\r\n    font-size: 14px;\r\n    resize: none;\r\n}\r\n\r\n/* Gallery Scroll */\r\n.gallery-scroll {\r\n    display: flex;\r\n    overflow-x: auto;\r\n    padding: 10px;\r\n    gap: 10px;\r\n    background-color: #fff;\r\n}\r\n\r\n.gallery-item {\r\n    flex: 0 0 80px;\r\n    height: 142px; /* 9:16 ratio */\r\n    border-radius: 8px;\r\n    overflow: hidden;\r\n    position: relative;\r\n    border: 2px solid transparent;\r\n}\r\n\r\n.gallery-item.selected {\r\n    border-color: #007AFF;\r\n}\r\n\r\n.gallery-item img {\r\n    width: 100%;\r\n    height: 100%;\r\n    object-fit: cover;\r\n}\r\n\r\n.delete-wp-btn {\r\n    position: absolute;\r\n    top: 2px;\r\n    right: 2px;\r\n    background: rgba(0,0,0,0.5);\r\n    color: white;\r\n    width: 20px;\r\n    height: 20px;\r\n    border-radius: 50%;\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    font-size: 12px;\r\n    padding: 0;\r\n    border: none;\r\n    cursor: pointer;\r\n}\r\n\r\n/* Icon Settings List */\r\n.icon-row {\r\n    display: flex;\r\n    align-items: center;\r\n    gap: 15px;\r\n    width: 100%;\r\n}\r\n\r\n.icon-preview-small {\r\n    width: 40px;\r\n    height: 40px;\r\n    border-radius: 10px;\r\n    background-color: #f2f2f7;\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    overflow: hidden;\r\n    flex-shrink: 0;\r\n}\r\n\r\n.icon-preview-small img {\r\n    width: 100%;\r\n    height: 100%;\r\n    object-fit: cover;\r\n}\r\n\r\n.icon-preview-small i {\r\n    font-size: 20px;\r\n    color: #8e8e93;\r\n}\r\n\r\n.icon-info {\r\n    flex: 1;\r\n    font-size: 17px;\r\n}\r\n\r\n.icon-actions {\r\n    display: flex;\r\n    gap: 10px;\r\n}\r\n\r\n/* Modal Styles */\r\n.modal {\r\n    position: absolute;\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    background-color: rgba(0, 0, 0, 0.5);\r\n    z-index: 200;\r\n    display: flex;\r\n    justify-content: center;\r\n    align-items: flex-end;\r\n    backdrop-filter: blur(5px);\r\n    transition: opacity 0.3s ease;\r\n}\r\n\r\n.modal.hidden {\r\n    display: none;\r\n    opacity: 0;\r\n    pointer-events: none;\r\n}\r\n\r\n.modal-content {\r\n    width: 100%;\r\n    height: 85%;\r\n    background-color: #fff;\r\n    border-radius: 20px 20px 0 0;\r\n    display: flex;\r\n    flex-direction: column;\r\n    overflow: hidden;\r\n    animation: slideUp 0.3s ease-out;\r\n}\r\n\r\n@keyframes slideUp {\r\n    from { transform: translateY(100%); }\r\n    to { transform: translateY(0); }\r\n}\r\n\r\n.modal-header {\r\n    padding: 15px 20px;\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n    border-bottom: 1px solid #eee;\r\n}\r\n\r\n.modal-header h3 {\r\n    font-size: 18px;\r\n    font-weight: 600;\r\n}\r\n\r\n.close-btn {\r\n    background: none;\r\n    border: none;\r\n    font-size: 24px;\r\n    cursor: pointer;\r\n    color: #333;\r\n}\r\n\r\n.modal-body {\r\n    flex: 1;\r\n    overflow-y: auto;\r\n    padding: 20px;\r\n}\r\n\r\n/* WeChat App Styles */\r\n.wechat-header {\r\n    height: 44px;\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n    padding: 0 15px;\r\n    /* 改为绝对定位，悬浮在内容之上 */\r\n    position: absolute;\r\n    top: 0;\r\n    width: 100%;\r\n    /* 默认背景色 */\r\n    background-color: var(--wechat-header-bg);\r\n    border-bottom: 1px solid var(--wechat-border);\r\n    z-index: 100;\r\n    transition: background-color 0.3s, color 0.3s;\r\n}\r\n\r\n/* 动态页和个人页激活时，Header 透明 */\r\n#wechat-app:has(#wechat-tab-moments.active) .wechat-header,\r\n#wechat-app:has(#wechat-tab-me.active) .wechat-header {\r\n    background-color: transparent;\r\n    border-bottom: none;\r\n}\r\n\r\n/* 动态页和个人页激活时，Header 按钮变白 */\r\n#wechat-app:has(#wechat-tab-moments.active) .wechat-header .wechat-icon-btn,\r\n#wechat-app:has(#wechat-tab-me.active) .wechat-header .wechat-icon-btn {\r\n    color: #fff;\r\n    text-shadow: 0 1px 2px rgba(0,0,0,0.5);\r\n}\r\n\r\n.wechat-title {\r\n    font-size: 17px;\r\n    font-weight: 600;\r\n}\r\n\r\n.wechat-icon-btn {\r\n    background: none;\r\n    border: none;\r\n    font-size: 18px;\r\n    color: #000;\r\n    cursor: pointer;\r\n    padding: 5px;\r\n}\r\n\r\n.header-actions {\r\n    display: flex;\r\n    gap: 15px;\r\n}\r\n\r\n.wechat-body {\r\n    flex: 1;\r\n    background-color: var(--wechat-bg);\r\n    overflow-y: auto;\r\n    padding-bottom: 50px; /* Tab bar height */\r\n    padding-top: 44px; /* 为 absolute header 留出空间 */\r\n}\r\n\r\n/* 动态页和个人页不需要 padding，让背景图通顶 */\r\n.wechat-body:has(#wechat-tab-moments.active),\r\n.wechat-body:has(#wechat-tab-me.active) {\r\n    padding-top: 0;\r\n}\r\n\r\n/* 确保 moments-nav-bar 样式正确 */\r\n.moments-nav-bar {\r\n    background-color: transparent !important;\r\n}\r\n\r\n.wechat-tab-content {\r\n    display: none;\r\n    height: 100%;\r\n}\r\n\r\n.wechat-tab-content.active {\r\n    display: block;\r\n}\r\n\r\n.wechat-tab-bar {\r\n    height: 50px;\r\n    background-color: #f7f7f7;\r\n    border-top: 1px solid var(--wechat-border);\r\n    display: flex;\r\n    justify-content: space-around;\r\n    align-items: center;\r\n    position: absolute;\r\n    bottom: 0;\r\n    width: 100%;\r\n    z-index: 10;\r\n}\r\n\r\n.wechat-tab-item {\r\n    display: flex;\r\n    flex-direction: column;\r\n    align-items: center;\r\n    gap: 2px;\r\n    color: #000;\r\n    font-size: 10px;\r\n    cursor: pointer;\r\n    flex: 1;\r\n}\r\n\r\n.wechat-tab-item i {\r\n    font-size: 20px;\r\n}\r\n\r\n.wechat-tab-item.active {\r\n    color: var(--wechat-green);\r\n}\r\n\r\n/* Contact List */\r\n.contact-list {\r\n    background-color: #fff;\r\n}\r\n\r\n.contact-item {\r\n    display: flex;\r\n    align-items: center;\r\n    padding: 10px 15px;\r\n    border-bottom: 1px solid var(--wechat-border);\r\n    cursor: pointer;\r\n}\r\n\r\n.contact-item:active {\r\n    background-color: #d9d9d9;\r\n}\r\n\r\n.contact-avatar {\r\n    width: 40px;\r\n    height: 40px;\r\n    border-radius: 4px;\r\n    margin-right: 10px;\r\n    object-fit: cover;\r\n}\r\n\r\n.contact-info {\r\n    flex: 1;\r\n}\r\n\r\n.contact-name {\r\n    font-size: 16px;\r\n    color: #000;\r\n    font-weight: 500;\r\n}\r\n\r\n.empty-state {\r\n    display: flex;\r\n    justify-content: center;\r\n    align-items: center;\r\n    height: 100%;\r\n    color: #999;\r\n    font-size: 14px;\r\n}\r\n\r\n/* Chat Screen */\r\n.sub-screen {\r\n    position: absolute;\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    background-color: var(--wechat-bg);\r\n    z-index: 150;\r\n    display: flex;\r\n    flex-direction: column;\r\n    transition: transform 0.3s ease;\r\n}\r\n\r\n.sub-screen.hidden {\r\n    transform: translateX(100%);\r\n    pointer-events: none;\r\n}\r\n\r\n.chat-header {\r\n    height: 44px;\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n    padding: 0 10px;\r\n    background-color: var(--wechat-header-bg);\r\n    border-bottom: 1px solid var(--wechat-border);\r\n}\r\n\r\n.chat-body {\r\n    flex: 1;\r\n    overflow-y: auto;\r\n    padding: 15px;\r\n    /* Hide scrollbar */\r\n    -ms-overflow-style: none;  /* IE and Edge */\r\n    scrollbar-width: none;  /* Firefox */\r\n}\r\n\r\n.chat-body::-webkit-scrollbar {\r\n    display: none;\r\n}\r\n\r\n.chat-input-area {\r\n    height: 50px;\r\n    background-color: #f7f7f7;\r\n    border-top: 1px solid var(--wechat-border);\r\n    display: flex;\r\n    align-items: center;\r\n    padding: 0 10px;\r\n    gap: 10px;\r\n}\r\n\r\n#chat-input {\r\n    flex: 1;\r\n    height: 36px;\r\n    border: none;\r\n    border-radius: 4px;\r\n    padding: 0 10px;\r\n    background-color: #fff;\r\n}\r\n\r\n#send-msg-btn, #trigger-ai-reply-btn {\r\n    background: none;\r\n    border: none;\r\n    color: var(--wechat-green);\r\n    font-size: 20px;\r\n    cursor: pointer;\r\n}\r\n\r\n/* Chat Messages */\r\n.chat-message {\r\n    display: flex;\r\n    margin-bottom: 15px;\r\n    align-items: flex-start;\r\n}\r\n\r\n.chat-message.user {\r\n    flex-direction: row-reverse;\r\n}\r\n\r\n.chat-avatar {\r\n    width: 40px;\r\n    height: 40px;\r\n    border-radius: 4px;\r\n    margin: 0 10px;\r\n    object-fit: cover;\r\n}\r\n\r\n.message-content {\r\n    background-color: #fff;\r\n    padding: 10px;\r\n    border-radius: 4px;\r\n    max-width: 70%;\r\n    position: relative;\r\n    font-size: 16px;\r\n    line-height: 1.4;\r\n    word-wrap: break-word;\r\n}\r\n\r\n.chat-message.user .message-content {\r\n    background-color: #95ec69; /* 微信绿 */\r\n}\r\n\r\n/* 气泡尖角 */\r\n.chat-message.other .message-content::before {\r\n    content: '';\r\n    position: absolute;\r\n    left: -6px;\r\n    top: 14px;\r\n    width: 0;\r\n    height: 0;\r\n    border-top: 6px solid transparent;\r\n    border-bottom: 6px solid transparent;\r\n    border-right: 6px solid #fff;\r\n}\r\n\r\n.chat-message.user .message-content::before {\r\n    content: '';\r\n    position: absolute;\r\n    right: -6px;\r\n    top: 14px;\r\n    width: 0;\r\n    height: 0;\r\n    border-top: 6px solid transparent;\r\n    border-bottom: 6px solid transparent;\r\n    border-left: 6px solid #95ec69;\r\n}\r\n\r\n/* Worldbook Styles */\r\n.wb-entry {\r\n    padding: 15px;\r\n    border-bottom: 1px solid #e5e5ea;\r\n    background-color: #fff;\r\n    cursor: pointer;\r\n}\r\n\r\n.wb-entry:active {\r\n    background-color: #f2f2f7;\r\n}\r\n\r\n.wb-header {\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n    margin-bottom: 5px;\r\n}\r\n\r\n.wb-keys {\r\n    font-weight: 600;\r\n    font-size: 16px;\r\n    color: #000;\r\n}\r\n\r\n.wb-status {\r\n    font-size: 12px;\r\n    padding: 2px 6px;\r\n    border-radius: 4px;\r\n}\r\n\r\n.wb-status.enabled {\r\n    background-color: #e1f7e6;\r\n    color: #07c160;\r\n}\r\n\r\n.wb-status.disabled {\r\n    background-color: #f2f2f7;\r\n    color: #8e8e93;\r\n}\r\n\r\n.wb-content {\r\n    font-size: 14px;\r\n    color: #666;\r\n    display: -webkit-box;\r\n    -webkit-line-clamp: 2;\r\n    -webkit-box-orient: vertical;\r\n    overflow: hidden;\r\n}\r\n\r\n/* Me Tab Styles */\r\n.me-profile-card {\r\n    background-color: #fff;\r\n    margin-bottom: 10px;\r\n    position: relative;\r\n    overflow: hidden;\r\n}\r\n\r\n.me-bg {\r\n    height: 270px;\r\n    background-color: #ccc;\r\n    background-size: cover;\r\n    background-position: center;\r\n    cursor: pointer;\r\n    margin-top:-100px;\r\n}\r\n\r\n.me-info {\r\n    padding: 0 20px 20px;\r\n    position: relative;\r\n}\r\n\r\n.me-avatar-row {\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: flex-end;\r\n    margin-top: -40px;\r\n    margin-bottom: 10px;\r\n}\r\n\r\n.me-avatar {\r\n    width: 80px;\r\n    height: 80px;\r\n    border-radius: 50%;\r\n    border: 3px solid #fff;\r\n    background-color: #fff;\r\n    object-fit: cover;\r\n}\r\n\r\n.me-edit-btn {\r\n    padding: 6px 12px;\r\n    border: 1px solid #ccc;\r\n    border-radius: 16px;\r\n    background: #fff;\r\n    font-size: 14px;\r\n    color: #333;\r\n    cursor: pointer;\r\n}\r\n\r\n.me-name {\r\n    font-size: 22px;\r\n    font-weight: 600;\r\n    margin-bottom: 4px;\r\n}\r\n\r\n.me-id {\r\n    font-size: 14px;\r\n    color: #888;\r\n    margin-bottom: 8px;\r\n}\r\n\r\n.me-desc {\r\n    font-size: 14px;\r\n    color: #333;\r\n}\r\n\r\n.persona-item {\r\n    display: flex;\r\n    align-items: center;\r\n    padding: 10px 15px;\r\n    border-bottom: 1px solid #eee;\r\n    cursor: pointer;\r\n}\r\n\r\n.persona-item.active {\r\n    background-color: #f0f9ff;\r\n}\r\n\r\n.persona-avatar {\r\n    width: 40px;\r\n    height: 40px;\r\n    border-radius: 50%;\r\n    margin-right: 10px;\r\n    object-fit: cover;\r\n}\r\n\r\n.persona-info {\r\n    flex: 1;\r\n}\r\n\r\n.persona-name {\r\n    font-weight: 500;\r\n}\r\n\r\n.persona-check {\r\n    color: #007AFF;\r\n    display: none;\r\n}\r\n\r\n.persona-item.active .persona-check {\r\n    display: block;\r\n}\r\n\r\n/* Moments Styles */\r\n.moments-container {\r\n    background-color: #fff;\r\n    min-height: 100%;\r\n}\r\n\r\n.moments-header {\r\n    position: relative;\r\n    margin-bottom: 30px;\r\n    padding-bottom: 0;\r\n    background-color: transparent;\r\n}\r\n\r\n.moments-cover {\r\n    height: 270px;\r\n    background-color: #333;\r\n    background-size: cover;\r\n    background-position: center;\r\n    cursor: pointer;\r\n}\r\n\r\n.moments-user-info {\r\n    position: absolute;\r\n    bottom: -25px;\r\n    right: 10px;\r\n    display: flex;\r\n    align-items: flex-start;\r\n    gap: 10px;\r\n}\r\n\r\n.moments-user-name {\r\n    color: #fff;\r\n    font-weight: 600;\r\n    font-size: 18px;\r\n    text-shadow: 0 1px 2px rgba(0,0,0,0.5);\r\n    margin-top: 20px;\r\n    margin-right: 10px;\r\n}\r\n\r\n.moments-user-avatar {\r\n    width: 70px;\r\n    height: 70px;\r\n    border-radius: 8px;\r\n    border: 2px solid #fff;\r\n    background-color: #fff;\r\n    object-fit: cover;\r\n}\r\n\r\n.moments-list {\r\n    padding: 0;\r\n    padding-bottom: 20px;\r\n}\r\n\r\n.moment-item {\r\n    display: flex;\r\n    padding: 15px;\r\n    border-bottom: 1px solid #f2f2f7;\r\n    gap: 10px;\r\n}\r\n\r\n.moment-avatar {\r\n    width: 40px;\r\n    height: 40px;\r\n    border-radius: 4px;\r\n    object-fit: cover;\r\n    flex-shrink: 0;\r\n}\r\n\r\n.moment-content {\r\n    flex: 1;\r\n}\r\n\r\n.moment-name {\r\n    color: var(--wechat-link);\r\n    font-weight: 600;\r\n    font-size: 16px;\r\n    margin-bottom: 5px;\r\n}\r\n\r\n.moment-text {\r\n    font-size: 15px;\r\n    color: #000;\r\n    line-height: 1.5;\r\n    margin-bottom: 10px;\r\n    word-wrap: break-word;\r\n}\r\n\r\n.moment-images {\r\n    display: grid;\r\n    gap: 5px;\r\n    margin-bottom: 10px;\r\n}\r\n\r\n.moment-images.single {\r\n    grid-template-columns: 1fr;\r\n    max-width: 200px;\r\n}\r\n\r\n.moment-images.grid {\r\n    grid-template-columns: repeat(3, 1fr);\r\n}\r\n\r\n.moment-img {\r\n    width: 100%;\r\n    aspect-ratio: 1;\r\n    object-fit: cover;\r\n    background-color: #f2f2f7;\r\n}\r\n\r\n.moment-info {\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n    margin-bottom: 10px;\r\n}\r\n\r\n.moment-time {\r\n    font-size: 12px;\r\n    color: #999;\r\n}\r\n\r\n.moment-delete {\r\n    font-size: 12px;\r\n    color: var(--wechat-link);\r\n    margin-left: 10px;\r\n    cursor: pointer;\r\n}\r\n\r\n.moment-action-btn {\r\n    background: #f7f7f7;\r\n    border: none;\r\n    border-radius: 4px;\r\n    padding: 2px 8px;\r\n    color: #576b95;\r\n    font-size: 14px;\r\n    cursor: pointer;\r\n}\r\n\r\n.moment-likes-comments {\r\n    background-color: #f7f7f7;\r\n    border-radius: 4px;\r\n    padding: 5px 10px;\r\n    position: relative;\r\n    margin-top: 5px;\r\n}\r\n\r\n.moment-likes-comments::before {\r\n    content: '';\r\n    position: absolute;\r\n    top: -6px;\r\n    left: 10px;\r\n    width: 0;\r\n    height: 0;\r\n    border-left: 6px solid transparent;\r\n    border-right: 6px solid transparent;\r\n    border-bottom: 6px solid #f7f7f7;\r\n}\r\n\r\n.moment-likes {\r\n    color: var(--wechat-link);\r\n    font-size: 14px;\r\n    line-height: 1.5;\r\n    border-bottom: 1px solid #e5e5e5;\r\n    padding-bottom: 5px;\r\n    margin-bottom: 5px;\r\n}\r\n\r\n.moment-likes i {\r\n    margin-right: 5px;\r\n}\r\n\r\n.moment-comments {\r\n    font-size: 14px;\r\n    line-height: 1.5;\r\n}\r\n\r\n.comment-item {\r\n    margin-bottom: 2px;\r\n}\r\n\r\n.comment-user {\r\n    color: var(--wechat-link);\r\n    font-weight: 500;\r\n}\r\n\r\n.comment-content {\r\n    color: #000;\r\n}\r\n\r\n/* Action Menu */\r\n.action-menu {\r\n    position: absolute;\r\n    bottom: -5px;\r\n    right: 30px;\r\n    background-color: #4c4c4c;\r\n    border-radius: 4px;\r\n    display: flex;\r\n    align-items: center;\r\n    padding: 0;\r\n    overflow: hidden;\r\n    transition: width 0.2s ease;\r\n    width: 0px;\r\n    height: 30px;\r\n    z-index: 10;\r\n}\r\n\r\n.action-menu.show {\r\n    width: 140px;\r\n}\r\n\r\n.action-menu-btn {\r\n    flex: 1;\r\n    background: none;\r\n    border: none;\r\n    color: #fff;\r\n    font-size: 14px;\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    gap: 5px;\r\n    height: 100%;\r\n    cursor: pointer;\r\n}\r\n\r\n.action-menu-btn:first-child {\r\n    border-right: 1px solid #333;\r\n}\r\n\r\n.action-menu-btn:active {\r\n    background-color: #333;\r\n}\r\n\r\n/* Post Moment Styles */\r\n.post-images-grid {\r\n    display: grid;\r\n    grid-template-columns: repeat(3, 1fr);\r\n    gap: 10px;\r\n}\r\n\r\n.post-image-item {\r\n    width: 100%;\r\n    aspect-ratio: 1;\r\n    position: relative;\r\n    border-radius: 4px;\r\n    overflow: hidden;\r\n}\r\n\r\n.post-image-item img {\r\n    width: 100%;\r\n    height: 100%;\r\n    object-fit: cover;\r\n}\r\n\r\n.add-image-btn {\r\n    width: 100%;\r\n    aspect-ratio: 1;\r\n    background-color: #f7f7f7;\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    color: #ccc;\r\n    font-size: 30px;\r\n    cursor: pointer;\r\n    border-radius: 4px;\r\n}\r\n</style>\n</head>\n<body>\n    <div class=\"screen-container\" id=\"screen-container\">\n        <!-- 状态栏模拟 -->\n        <div class=\"status-bar\">\n            <div class=\"time\">9:41</div>\n            <div class=\"status-icons\">\n                <i class=\"fas fa-signal\"></i>\n                <i class=\"fas fa-wifi\"></i>\n                <i class=\"fas fa-battery-full\"></i>\n            </div>\n        </div>\n\n        <!-- 顶部区域 -->\n        <div class=\"top-section\">\n            <div class=\"profile-container\">\n                <!-- 头像 -->\n                <div class=\"avatar\">\n                    <img src=\"https://api.dicebear.com/7.x/avataaars/svg?seed=Felix\" alt=\"User Avatar\">\n                </div>\n                <!-- 背景页脚 -->\n                <div class=\"profile-card-bg\">\n                    <div class=\"user-info\">\n                        <h2>User Name</h2>\n                        <p>Welcome back</p>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <!-- 主要内容区域 -->\n        <div class=\"main-content\">\n            <!-- 左侧信封 -->\n            <div class=\"left-area\">\n                <div class=\"app-item large-item\">\n                    <div class=\"app-icon icon-envelope\">\n                        <i class=\"fas fa-envelope\"></i>\n                    </div>\n                    <span class=\"app-label\">信息</span>\n                </div>\n            </div>\n            \n            <!-- 右侧应用网格 -->\n            <div class=\"right-area\">\n                <div class=\"app-grid\">\n                    <div class=\"app-item\" id=\"app-wechat\">\n                        <div class=\"app-icon icon-wechat\">\n                            <i class=\"fab fa-weixin\"></i>\n                        </div>\n                        <span class=\"app-label\">微信</span>\n                    </div>\n                    <div class=\"app-item\" id=\"app-worldbook\">\n                        <div class=\"app-icon icon-world\">\n                            <i class=\"fas fa-globe\"></i>\n                        </div>\n                        <span class=\"app-label\">世界书</span>\n                    </div>\n                    <div class=\"app-item\" id=\"app-settings\">\n                        <div class=\"app-icon icon-settings\">\n                            <i class=\"fas fa-cog\"></i>\n                        </div>\n                        <span class=\"app-label\">设置</span>\n                    </div>\n                    <div class=\"app-item\" id=\"app-theme\">\n                        <div class=\"app-icon icon-theme\">\n                            <i class=\"fas fa-paint-brush\"></i>\n                        </div>\n                        <span class=\"app-label\">美化</span>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <!-- 底部Dock栏 -->\n        <div class=\"dock-bar\">\n            <div class=\"dock-container\">\n                <div class=\"app-item dock-item\">\n                    <div class=\"app-icon icon-shopping\">\n                        <i class=\"fas fa-shopping-bag\"></i>\n                    </div>\n                    <span class=\"app-label\">购物</span>\n                </div>\n                <div class=\"app-item dock-item\">\n                    <div class=\"app-icon icon-forum\">\n                        <i class=\"fas fa-comments\"></i>\n                    </div>\n                    <span class=\"app-label\">论坛</span>\n                </div>\n                <div class=\"app-item dock-item\">\n                    <div class=\"app-icon icon-phone\">\n                        <i class=\"fas fa-mobile-alt\"></i>\n                    </div>\n                    <span class=\"app-label\">查手机</span>\n                </div>\n            </div>\n        </div>\n        \n        <!-- 底部Home Indicator -->\n        <div class=\"home-indicator\"></div>\n\n        <!-- 设置全屏App -->\n        <div id=\"settings-app\" class=\"app-screen hidden\">\n            <div class=\"app-header\">\n                <button id=\"close-settings-app\" class=\"back-btn\"><i class=\"fas fa-chevron-left\"></i> 返回</button>\n                <h3>设置</h3>\n                <div style=\"width: 60px;\"></div>\n            </div>\n            <div class=\"app-body\">\n                <!-- 主 API 设置 -->\n                <div class=\"section-title\">主 API 设置</div>\n                \n                <!-- 预设 -->\n                <div class=\"ios-list-group\">\n                    <div class=\"list-item\">\n                        <div class=\"list-content column\">\n                            <label>配置预设</label>\n                            <div class=\"input-row full-width\">\n                                <select id=\"ai-preset-select\">\n                                    <option value=\"\">-- 选择预设 --</option>\n                                </select>\n                                <button id=\"save-ai-preset\" class=\"ios-btn-small\">保存</button>\n                                <button id=\"delete-ai-preset\" class=\"ios-btn-small danger\">删除</button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- API 详情 -->\n                <div class=\"ios-list-group\">\n                    <div class=\"list-item\">\n                        <div class=\"list-content column\">\n                            <label>API 地址 (Base URL)</label>\n                            <input type=\"text\" id=\"ai-api-url\" placeholder=\"https://api.openai.com/v1\">\n                        </div>\n                    </div>\n                    <div class=\"list-item\">\n                        <div class=\"list-content column\">\n                            <label>API 密钥 (Key)</label>\n                            <input type=\"password\" id=\"ai-api-key\" placeholder=\"sk-...\">\n                        </div>\n                    </div>\n                    <div class=\"list-item\">\n                        <div class=\"list-content column\">\n                            <div class=\"input-row full-width\">\n                                <button id=\"fetch-models\" class=\"ios-btn-block\">拉取模型列表</button>\n                            </div>\n                            <div class=\"input-row full-width\" style=\"margin-top: 10px;\">\n                                <select id=\"ai-model-select\">\n                                    <option value=\"\">请先拉取模型</option>\n                                </select>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"list-item\">\n                        <div class=\"list-content column\">\n                            <div style=\"display: flex; justify-content: space-between; width: 100%;\">\n                                <label>温度 (Temperature)</label>\n                                <span id=\"ai-temp-value\">0.7</span>\n                            </div>\n                            <input type=\"range\" id=\"ai-temperature\" min=\"0\" max=\"2\" step=\"0.1\" value=\"0.7\" style=\"width: 100%;\">\n                        </div>\n                    </div>\n                </div>\n\n                <!-- 副 API 设置 -->\n                <div class=\"section-title\">副 API 设置</div>\n                \n                <!-- 预设 -->\n                <div class=\"ios-list-group\">\n                    <div class=\"list-item\">\n                        <div class=\"list-content column\">\n                            <label>配置预设</label>\n                            <div class=\"input-row full-width\">\n                                <select id=\"ai-preset-select-2\">\n                                    <option value=\"\">-- 选择预设 --</option>\n                                </select>\n                                <button id=\"save-ai-preset-2\" class=\"ios-btn-small\">保存</button>\n                                <button id=\"delete-ai-preset-2\" class=\"ios-btn-small danger\">删除</button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- API 详情 -->\n                <div class=\"ios-list-group\">\n                    <div class=\"list-item\">\n                        <div class=\"list-content column\">\n                            <label>API 地址 (Base URL)</label>\n                            <input type=\"text\" id=\"ai-api-url-2\" placeholder=\"https://api.openai.com/v1\">\n                        </div>\n                    </div>\n                    <div class=\"list-item\">\n                        <div class=\"list-content column\">\n                            <label>API 密钥 (Key)</label>\n                            <input type=\"password\" id=\"ai-api-key-2\" placeholder=\"sk-...\">\n                        </div>\n                    </div>\n                    <div class=\"list-item\">\n                        <div class=\"list-content column\">\n                            <div class=\"input-row full-width\">\n                                <button id=\"fetch-models-2\" class=\"ios-btn-block\">拉取模型列表</button>\n                            </div>\n                            <div class=\"input-row full-width\" style=\"margin-top: 10px;\">\n                                <select id=\"ai-model-select-2\">\n                                    <option value=\"\">请先拉取模型</option>\n                                </select>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"list-item\">\n                        <div class=\"list-content column\">\n                            <div style=\"display: flex; justify-content: space-between; width: 100%;\">\n                                <label>温度 (Temperature)</label>\n                                <span id=\"ai-temp-value-2\">0.7</span>\n                            </div>\n                            <input type=\"range\" id=\"ai-temperature-2\" min=\"0\" max=\"2\" step=\"0.1\" value=\"0.7\" style=\"width: 100%;\">\n                        </div>\n                    </div>\n                </div>\n\n                <!-- 全局操作 -->\n                <div class=\"ios-list-group\">\n                    <div class=\"list-item\">\n                        <button id=\"save-all-settings\" class=\"ios-btn-block\">保存所有配置</button>\n                    </div>\n                </div>\n                \n                <div style=\"height: 50px;\"></div>\n            </div>\n        </div>\n\n        <!-- 微信全屏App -->\n        <div id=\"wechat-app\" class=\"app-screen hidden\">\n            <div class=\"wechat-header\">\n                <button id=\"close-wechat-app\" class=\"wechat-icon-btn\" style=\"font-size: 16px; width: auto;\"><i class=\"fas fa-chevron-left\"></i></button>\n                <span class=\"wechat-title\"></span>\n                <div class=\"header-actions\">\n                    <button id=\"wechat-add-contact\" class=\"wechat-icon-btn\"><i class=\"fas fa-plus\"></i></button>\n                </div>\n            </div>\n\n            <div class=\"wechat-body\">\n                <!-- 好友列表页 -->\n                <div id=\"wechat-tab-contacts\" class=\"wechat-tab-content active\">\n                    <div class=\"contact-list\" id=\"contact-list\">\n                        <!-- 联系人项将通过JS生成 -->\n                    </div>\n                </div>\n                <!-- 动态页 -->\n                <div id=\"wechat-tab-moments\" class=\"wechat-tab-content\">\n                    <div class=\"moments-nav-bar\" style=\"position: absolute; top: 0; width: 100%; height: 60px; z-index: 20; display: flex; justify-content: flex-end; padding: 10px 15px;\">\n                        <button id=\"add-moment-btn\" class=\"wechat-icon-btn\" style=\"color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5);\"><i class=\"fas fa-camera\"></i></button>\n                    </div>\n                    <div id=\"moments-container\" class=\"moments-container\">\n                        <!-- 朋友圈头部将通过JS生成 -->\n                    </div>\n                </div>\n                <!-- 我的页 -->\n                <div id=\"wechat-tab-me\" class=\"wechat-tab-content\">\n                    <div id=\"me-profile-container\">\n                        <!-- 资料卡将通过JS生成 -->\n                    </div>\n                    \n                    <div class=\"ios-list-group\" style=\"margin-top: 20px;\">\n                        <div class=\"list-item center-content\" id=\"switch-persona-btn\">\n                            <span style=\"color: #007AFF;\">管理身份</span>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 底栏 -->\n            <div class=\"wechat-tab-bar\">\n                <div class=\"wechat-tab-item active\" data-tab=\"contacts\">\n                    <i class=\"fas fa-comment\"></i>\n                    <span>微信</span>\n                </div>\n                <div class=\"wechat-tab-item\" data-tab=\"moments\">\n                    <i class=\"fas fa-star\"></i>\n                    <span>动态</span>\n                </div>\n                <div class=\"wechat-tab-item\" data-tab=\"me\">\n                    <i class=\"fas fa-user\"></i>\n                    <span>我</span>\n                </div>\n            </div>\n\n            <!-- 聊天设置全屏页 -->\n            <div id=\"chat-settings-screen\" class=\"sub-screen hidden\" style=\"z-index: 160;\">\n                <div class=\"chat-header\">\n                    <button id=\"close-chat-settings\" class=\"back-btn\"><i class=\"fas fa-chevron-left\"></i> 返回</button>\n                    <span>聊天详情</span>\n                    <div style=\"width: 60px;\"></div>\n                </div>\n                <div class=\"app-body\" style=\"background-color: var(--bg-color);\">\n                    <div class=\"ios-list-group\">\n                        <div class=\"list-item\">\n                            <div class=\"list-content column\">\n                                <label>对方头像</label>\n                                <input type=\"file\" id=\"chat-setting-avatar\" accept=\"image/*\" class=\"file-input-hidden\">\n                                <label for=\"chat-setting-avatar\" class=\"ios-btn\">选择图片</label>\n                            </div>\n                        </div>\n                        <div class=\"list-item\">\n                            <div class=\"list-content column\">\n                                <label>对方备注</label>\n                                <input type=\"text\" id=\"chat-setting-remark\" placeholder=\"输入备注\">\n                            </div>\n                        </div>\n                        <div class=\"list-item\">\n                            <div class=\"list-content column\">\n                                <label>对方人设</label>\n                                <textarea id=\"chat-setting-persona\" placeholder=\"输入人设...\"></textarea>\n                            </div>\n                        </div>\n                        <div class=\"list-item\">\n                            <div class=\"list-content column\">\n                                <label>我的身份 (本聊天)</label>\n                                <select id=\"chat-setting-user-persona\" style=\"width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; margin-top: 5px;\">\n                                    <option value=\"\">-- 选择身份 --</option>\n                                </select>\n                            </div>\n                        </div>\n                        <div class=\"list-item\">\n                            <div class=\"list-content column\">\n                                <label>我的头像 (本聊天)</label>\n                                <input type=\"file\" id=\"chat-setting-my-avatar\" accept=\"image/*\" class=\"file-input-hidden\">\n                                <label for=\"chat-setting-my-avatar\" class=\"ios-btn\">选择图片</label>\n                            </div>\n                        </div>\n                        <div class=\"list-item\">\n                            <div class=\"list-content column\">\n                                <label>聊天背景</label>\n                                <input type=\"file\" id=\"chat-setting-bg\" accept=\"image/*\" class=\"file-input-hidden\">\n                                <label for=\"chat-setting-bg\" class=\"ios-btn\">选择图片</label>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"ios-list-group\">\n                        <div class=\"list-item\">\n                            <button id=\"save-chat-settings-btn\" class=\"ios-btn-block\">保存配置</button>\n                        </div>\n                        <div class=\"list-item\">\n                            <button id=\"trigger-ai-moment-btn\" class=\"ios-btn-block secondary\">让TA发动态</button>\n                        </div>\n                    </div>\n                    <div class=\"ios-list-group\">\n                        <div class=\"list-item center-content\" id=\"clear-chat-history-btn\">\n                            <span class=\"danger-text\">清空聊天记录</span>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 添加联系人弹窗 -->\n            <div id=\"add-contact-modal\" class=\"modal hidden\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header\">\n                        <h3>添加联系人</h3>\n                        <button class=\"close-btn\" id=\"close-add-contact\">×</button>\n                    </div>\n                    <div class=\"modal-body\">\n                        <div class=\"setting-group\">\n                            <label>头像</label>\n                            <input type=\"file\" id=\"contact-avatar-upload\" accept=\"image/*\">\n                        </div>\n                        <div class=\"setting-group\">\n                            <label>姓名</label>\n                            <input type=\"text\" id=\"contact-name\" placeholder=\"输入姓名\">\n                        </div>\n                        <div class=\"setting-group\">\n                            <label>备注</label>\n                            <input type=\"text\" id=\"contact-remark\" placeholder=\"输入备注\">\n                        </div>\n                        <div class=\"setting-group\">\n                            <label>人设 (Prompt)</label>\n                            <textarea id=\"contact-persona\" placeholder=\"例如：你是一个热心的邻居...\"></textarea>\n                        </div>\n                        <div class=\"setting-group\">\n                            <label>聊天风格</label>\n                            <input type=\"text\" id=\"contact-style\" placeholder=\"例如：幽默、简洁...\">\n                        </div>\n                        <button id=\"save-contact-btn\" class=\"ios-btn-block\">保存并聊天</button>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 聊天页面 -->\n            <div id=\"chat-screen\" class=\"sub-screen hidden\">\n                <div class=\"chat-header\">\n                    <button id=\"back-to-contacts\" class=\"back-btn\"><i class=\"fas fa-chevron-left\"></i></button>\n                    <span id=\"chat-title\">用户名</span>\n                    <button id=\"chat-settings-btn\" class=\"wechat-icon-btn\"><i class=\"fas fa-ellipsis-h\"></i></button>\n                </div>\n                <div class=\"chat-body\" id=\"chat-messages\">\n                    <!-- 消息列表 -->\n                </div>\n                <div class=\"chat-input-area\">\n                    <input type=\"text\" id=\"chat-input\" placeholder=\"回车发送，点击右侧AI回复...\">\n                    <button id=\"trigger-ai-reply-btn\"><i class=\"fas fa-robot\"></i></button>\n                </div>\n            </div>\n        </div>\n\n        <!-- 世界书全屏App -->\n        <div id=\"worldbook-app\" class=\"app-screen hidden\">\n            <div class=\"app-header\">\n                <button id=\"close-worldbook-app\" class=\"back-btn\"><i class=\"fas fa-chevron-left\"></i> 返回</button>\n                <h3>世界书</h3>\n                <button id=\"add-worldbook-entry\" class=\"wechat-icon-btn\"><i class=\"fas fa-plus\"></i></button>\n            </div>\n            <div class=\"app-body\">\n                <div class=\"ios-list-group\" id=\"worldbook-list\">\n                    <!-- 条目列表将通过JS生成 -->\n                </div>\n                <div class=\"empty-state\" id=\"worldbook-empty\" style=\"display: none;\">\n                    暂无条目，点击右上角添加\n                </div>\n            </div>\n            \n            <!-- 编辑弹窗 -->\n            <div id=\"worldbook-edit-modal\" class=\"modal hidden\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header\">\n                        <h3 id=\"worldbook-modal-title\">编辑条目</h3>\n                        <button class=\"close-btn\" id=\"close-worldbook-edit\">×</button>\n                    </div>\n                    <div class=\"modal-body\">\n                        <div class=\"setting-group\">\n                            <label>关键字 (逗号分隔)</label>\n                            <input type=\"text\" id=\"wb-keys\" placeholder=\"例如: 城堡, 国王\">\n                        </div>\n                        <div class=\"setting-group\">\n                            <label>内容</label>\n                            <textarea id=\"wb-content\" placeholder=\"描述内容...\" style=\"height: 200px;\"></textarea>\n                        </div>\n                        <div class=\"setting-group\" style=\"display: flex; align-items: center; gap: 10px;\">\n                            <label style=\"margin: 0;\">启用</label>\n                            <input type=\"checkbox\" id=\"wb-enabled\" checked=\"\" style=\"width: auto;\">\n                        </div>\n                        <button id=\"save-worldbook-btn\" class=\"ios-btn-block\">保存</button>\n                        <button id=\"delete-worldbook-btn\" class=\"ios-btn-block danger\" style=\"margin-top: 10px;\">删除</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <!-- 身份管理弹窗 -->\n        <div id=\"persona-manage-modal\" class=\"modal hidden\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h3>管理身份</h3>\n                    <button class=\"close-btn\" id=\"close-persona-manage\">×</button>\n                </div>\n                <div class=\"modal-body\">\n                    <div id=\"persona-list\" class=\"ios-list-group\">\n                        <!-- 列表 -->\n                    </div>\n                    <button id=\"add-persona-btn\" class=\"ios-btn-block\">新建身份</button>\n                </div>\n            </div>\n        </div>\n\n            <!-- 身份编辑弹窗 (简化版) -->\n            <div id=\"persona-edit-modal\" class=\"modal hidden\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header\">\n                        <h3 id=\"persona-modal-title\">编辑身份</h3>\n                        <button class=\"close-btn\" id=\"close-persona-edit\">×</button>\n                    </div>\n                    <div class=\"modal-body\">\n                        <div class=\"setting-group\">\n                            <label>身份名称 (发送给AI的名字)</label>\n                            <input type=\"text\" id=\"persona-name\" placeholder=\"例如：哥哥、老板...\">\n                        </div>\n                        <div class=\"setting-group\">\n                            <label>AI认知中的我 (发送给AI的人设)</label>\n                            <textarea id=\"persona-ai-prompt\" placeholder=\"例如：我是你的哥哥，性格...\"></textarea>\n                        </div>\n                        <button id=\"save-persona-btn\" class=\"ios-btn-block\">保存</button>\n                        <button id=\"delete-persona-btn\" class=\"ios-btn-block danger\" style=\"display: none;\">删除</button>\n                    </div>\n                </div>\n            </div>\n            \n            <!-- 隐藏的文件输入框，用于资料卡直接修改 -->\n            <input type=\"file\" id=\"me-avatar-input\" accept=\"image/*\" class=\"file-input-hidden\">\n            <input type=\"file\" id=\"me-bg-input\" accept=\"image/*\" class=\"file-input-hidden\">\n            <input type=\"file\" id=\"moments-bg-input\" accept=\"image/*\" class=\"file-input-hidden\">\n\n            <!-- 发布动态弹窗 -->\n            <div id=\"post-moment-modal\" class=\"app-screen hidden\" style=\"z-index: 200; background-color: #fff;\">\n                <div class=\"app-header\">\n                    <button id=\"close-post-moment\" class=\"back-btn\" style=\"color: #000;\">取消</button>\n                    <button id=\"do-post-moment\" class=\"ios-btn-small\" style=\"background-color: #07C160; color: #fff; border-radius: 4px; padding: 4px 12px;\">发表</button>\n                </div>\n                <div class=\"app-body\" style=\"padding: 20px;\">\n                    <textarea id=\"post-moment-text\" placeholder=\"这一刻的想法...\" style=\"width: 100%; height: 100px; border: none; font-size: 16px; resize: none; margin-bottom: 20px;\"></textarea>\n                    <div id=\"post-moment-images\" class=\"post-images-grid\">\n                        <!-- 图片预览 -->\n                        <div class=\"add-image-btn\" id=\"add-moment-image-btn\">\n                            <i class=\"fas fa-plus\"></i>\n                        </div>\n                    </div>\n                    <input type=\"file\" id=\"post-moment-file-input\" accept=\"image/*\" multiple=\"\" class=\"file-input-hidden\">\n                </div>\n            </div>\n\n        <!-- 美化全屏App -->\n        <div id=\"theme-app\" class=\"app-screen hidden\">\n            <div class=\"app-header\">\n                <button id=\"close-theme-app\" class=\"back-btn\"><i class=\"fas fa-chevron-left\"></i> 返回</button>\n                <h3>美化中心</h3>\n                <div style=\"width: 60px;\"></div> <!-- 占位符保持标题居中 -->\n            </div>\n            \n            <div class=\"app-body\">\n                <!-- 字体设置区块 -->\n                <div class=\"section-title\">字体设置</div>\n                <div class=\"ios-list-group\">\n                    <div class=\"list-item\">\n                        <div class=\"list-content column\">\n                            <label>字体预设</label>\n                            <div class=\"input-row full-width\">\n                                <select id=\"font-preset-select\">\n                                    <option value=\"\">-- 选择预设 --</option>\n                                </select>\n                                <button id=\"save-font-preset\" class=\"ios-btn-small\">保存</button>\n                                <button id=\"delete-font-preset\" class=\"ios-btn-small danger\">删除</button>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"list-item\">\n                        <div class=\"list-content\">\n                            <label>上传字体文件</label>\n                            <input type=\"file\" id=\"font-upload\" accept=\".ttf,.otf,.woff,.woff2\" class=\"file-input-hidden\">\n                            <label for=\"font-upload\" class=\"ios-btn\">选择文件</label>\n                        </div>\n                    </div>\n                    <div class=\"list-item\">\n                        <div class=\"list-content column\">\n                            <label>网络字体链接</label>\n                            <div class=\"input-row full-width\">\n                                <input type=\"text\" id=\"font-url\" placeholder=\"https://...\">\n                                <button id=\"apply-font-url\" class=\"ios-btn-small\">应用</button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- 壁纸设置区块 -->\n                <div class=\"section-title\">壁纸设置</div>\n                <div class=\"ios-list-group\">\n                    <div class=\"list-item\">\n                        <div class=\"list-content\">\n                            <label>上传壁纸</label>\n                            <input type=\"file\" id=\"wallpaper-upload\" accept=\"image/*\" class=\"file-input-hidden\">\n                            <label for=\"wallpaper-upload\" class=\"ios-btn\">选择图片</label>\n                        </div>\n                    </div>\n                    <div class=\"list-item no-padding\">\n                        <div id=\"wallpaper-gallery\" class=\"gallery-scroll\">\n                            <!-- 壁纸缩略图将在这里生成 -->\n                        </div>\n                    </div>\n                    <div class=\"list-item center-content\" id=\"reset-wallpaper\">\n                        <span class=\"danger-text\">重置默认壁纸</span>\n                    </div>\n                </div>\n\n                <!-- 图标设置区块 -->\n                <div class=\"section-title\">应用图标</div>\n                <div class=\"ios-list-group\" id=\"icon-setting-list\">\n                    <!-- 图标设置项将通过JS动态生成 -->\n                </div>\n                <div class=\"ios-list-group\">\n                    <div class=\"list-item center-content\" id=\"reset-icons\">\n                        <span class=\"danger-text\">重置所有图标</span>\n                    </div>\n                </div>\n\n                <!-- CSS编辑器区块 -->\n                <div class=\"section-title\">高级自定义 (CSS)</div>\n                <div class=\"ios-list-group\">\n                    <div class=\"list-item\">\n                        <div class=\"list-content column\">\n                            <label>CSS预设</label>\n                            <div class=\"input-row full-width\">\n                                <select id=\"css-preset-select\">\n                                    <option value=\"\">-- 选择预设 --</option>\n                                </select>\n                                <button id=\"save-css-preset\" class=\"ios-btn-small\">保存</button>\n                                <button id=\"delete-css-preset\" class=\"ios-btn-small danger\">删除</button>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"list-item no-padding\">\n                        <textarea id=\"css-editor\" placeholder=\"/* 在此输入自定义CSS */\"></textarea>\n                    </div>\n                    <div class=\"list-item\">\n                        <div class=\"button-row full-width\">\n                            <button id=\"save-css\" class=\"ios-btn-block\">应用并保存CSS配置</button>\n                            <button id=\"export-css\" class=\"ios-btn-block secondary\">导出CSS</button>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- 数据管理区块 -->\n                <div class=\"section-title\">数据管理</div>\n                <div class=\"ios-list-group\">\n                    <div class=\"list-item\">\n                        <div class=\"button-row full-width\">\n                            <button id=\"save-config\" class=\"ios-btn-block\">保存当前配置</button>\n                            <button id=\"load-config\" class=\"ios-btn-block secondary\">加载配置</button>\n                        </div>\n                    </div>\n                    <div class=\"list-item\">\n                        <div class=\"button-row full-width\">\n                            <button id=\"export-json\" class=\"ios-btn-block secondary\">导出JSON</button>\n                            <label for=\"import-json\" class=\"ios-btn-block secondary file-label\">\n                                导入JSON\n                                <input type=\"file\" id=\"import-json\" accept=\".json\" style=\"display: none;\">\n                            </label>\n                        </div>\n                    </div>\n                </div>\n                \n                <div style=\"height: 50px;\"></div> <!-- 底部留白 -->\n            </div>\n        </div>\n    </div>\n    \n    <!-- 引入 localForage 用于存储大文件 (可选，如果需要) -->\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js\"><\/script>\n    <script>document.addEventListener('DOMContentLoaded', () => {\r\n    console.log('Script loaded');\r\n\r\n    // 状态管理\r\n    const state = {\r\n        fonts: [],\r\n        wallpapers: [],\r\n        icons: {},\r\n        css: '',\r\n        currentFont: 'default',\r\n        currentWallpaper: null,\r\n        fontPresets: [],\r\n        cssPresets: [],\r\n        aiSettings: {\r\n            url: '',\r\n            key: '',\r\n            model: '',\r\n            temperature: 0.7\r\n        },\r\n        aiPresets: [],\r\n        aiSettings2: {\r\n            url: '',\r\n            key: '',\r\n            model: '',\r\n            temperature: 0.7\r\n        },\r\n        aiPresets2: [],\r\n        contacts: [], // { id, name, remark, avatar, persona, style, myAvatar, chatBg }\r\n        currentChatContactId: null,\r\n        chatHistory: {}, // { contactId: [{ role: 'user'|'assistant', content: '...' }] }\r\n        worldbook: [], // { id, keys: [], content: '', enabled: true }\r\n        userPersonas: [], // { id, title, aiPrompt, name }\r\n        currentUserPersonaId: null,\r\n        userProfile: { // 全局资料卡信息\r\n            name: 'User Name',\r\n            avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix',\r\n            bgImage: '',\r\n            momentsBgImage: '',\r\n            desc: '点击此处添加个性签名',\r\n            wxid: 'wxid_123456'\r\n        },\r\n        moments: [] // { id, contactId, content, images: [], time, likes: [], comments: [] }\r\n    };\r\n\r\n    // DOM 元素\r\n    const appScreen = document.getElementById('theme-app');\r\n    const openBtn = document.getElementById('app-theme');\r\n    const closeBtn = document.getElementById('close-theme-app');\r\n    \r\n    const settingsAppScreen = document.getElementById('settings-app');\r\n    const openSettingsBtn = document.getElementById('app-settings');\r\n    const closeSettingsBtn = document.getElementById('close-settings-app');\r\n    \r\n    const wechatAppScreen = document.getElementById('wechat-app');\r\n    const openWechatBtn = document.getElementById('app-wechat');\r\n    const closeWechatBtn = document.getElementById('close-wechat-app');\r\n    \r\n    const worldbookAppScreen = document.getElementById('worldbook-app');\r\n    const openWorldbookBtn = document.getElementById('app-worldbook');\r\n    const closeWorldbookBtn = document.getElementById('close-worldbook-app');\r\n    \r\n    const screenContainer = document.getElementById('screen-container');\r\n\r\n    // 应用列表配置\r\n    const appList = [\r\n        { id: 'icon-envelope', name: '信息', selector: '.icon-envelope' },\r\n        { id: 'icon-wechat', name: '微信', selector: '.icon-wechat' },\r\n        { id: 'icon-world', name: '世界书', selector: '.icon-world' },\r\n        { id: 'icon-settings', name: '设置', selector: '.icon-settings' },\r\n        { id: 'icon-theme', name: '美化', selector: '.icon-theme' },\r\n        { id: 'icon-shopping', name: '购物', selector: '.icon-shopping' },\r\n        { id: 'icon-forum', name: '论坛', selector: '.icon-forum' },\r\n        { id: 'icon-phone', name: '查手机', selector: '.icon-phone' }\r\n    ];\r\n\r\n    // 处理应用点击\r\n    function handleAppClick(app) {\r\n        console.log('App clicked:', app.name);\r\n        \r\n        // 定义应用ID到全屏页面ID的映射\r\n        const appMap = {\r\n            'icon-theme': 'theme-app',\r\n            'icon-settings': 'settings-app',\r\n            'icon-wechat': 'wechat-app',\r\n            'icon-world': 'worldbook-app'\r\n        };\r\n\r\n        const screenId = appMap[app.id];\r\n        \r\n        if (screenId) {\r\n            const screen = document.getElementById(screenId);\r\n            if (screen) {\r\n                screen.classList.remove('hidden');\r\n            }\r\n        } else {\r\n            alert(`${app.name} 功能开发中...`);\r\n        }\r\n    }\r\n\r\n    // 初始化\r\n    init();\r\n\r\n    function init() {\r\n        setupEventListeners();\r\n        setupIOSFullScreen(); // 添加iOS全屏适配\r\n        \r\n        try {\r\n            loadConfig();\r\n        } catch (e) {\r\n            console.error('加载配置失败:', e);\r\n        }\r\n\r\n        try {\r\n            renderWallpaperGallery();\r\n        } catch (e) {\r\n            console.error('渲染壁纸画廊失败:', e);\r\n        }\r\n\r\n        try {\r\n            renderIconSettings();\r\n        } catch (e) {\r\n            console.error('渲染图标设置失败:', e);\r\n        }\r\n\r\n        try {\r\n            applyConfig();\r\n        } catch (e) {\r\n            console.error('应用配置失败:', e);\r\n        }\r\n        \r\n        renderFontPresets();\r\n        renderCssPresets();\r\n        renderAiPresets();\r\n        renderAiPresets(true);\r\n        updateAiUi();\r\n        updateAiUi(true);\r\n        renderContactList();\r\n        renderWorldbookList();\r\n        renderMeTab();\r\n        renderMoments();\r\n    }\r\n\r\n    // iOS全屏适配逻辑\r\n    function setupIOSFullScreen() {\r\n        // 检测是否在iOS独立应用模式下运行\r\n        function isInStandaloneMode() {\r\n            return (\r\n                window.matchMedia('(display-mode: standalone)').matches ||\r\n                window.navigator.standalone ||\r\n                document.referrer.includes('android-app://')\r\n            );\r\n        }\r\n\r\n        // 检测是否在iOS中\r\n        function isIOS() {\r\n            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;\r\n        }\r\n\r\n        // 页面加载时应用全屏样式\r\n        if (isIOS() && isInStandaloneMode()) {\r\n            document.body.classList.add('ios-standalone');\r\n            \r\n            // 动态添加meta标签（如果需要）\r\n            if (!document.querySelector('meta[name=\"apple-mobile-web-app-capable\"]')) {\r\n                const meta = document.createElement('meta');\r\n                meta.name = 'apple-mobile-web-app-capable';\r\n                meta.content = 'yes';\r\n                document.head.appendChild(meta);\r\n            }\r\n        }\r\n\r\n        // 防止iOS缩放\r\n        document.addEventListener('touchstart', function(event) {\r\n            if (event.touches.length > 1) {\r\n                event.preventDefault();\r\n            }\r\n        }, { passive: false });\r\n\r\n        let lastTouchEnd = 0;\r\n        document.addEventListener('touchend', function(event) {\r\n            const now = (new Date()).getTime();\r\n            if (now - lastTouchEnd <= 300) {\r\n                event.preventDefault();\r\n            }\r\n            lastTouchEnd = now;\r\n        }, false);\r\n    }\r\n\r\n    // 事件监听设置\r\n    function setupEventListeners() {\r\n        console.log('Setting up event listeners');\r\n        \r\n        // 统一绑定应用图标点击事件\r\n        appList.forEach(app => {\r\n            // 通过选择器找到图标元素\r\n            const iconEl = document.querySelector(app.selector);\r\n            if (iconEl) {\r\n                // 找到最近的 .app-item 父元素作为点击目标\r\n                const appItem = iconEl.closest('.app-item');\r\n                if (appItem) {\r\n                    // 移除旧的监听器（如果有）并添加新的\r\n                    appItem.onclick = () => handleAppClick(app);\r\n                    appItem.style.cursor = 'pointer';\r\n                }\r\n            }\r\n        });\r\n\r\n        // 绑定关闭按钮事件\r\n        if (closeBtn) closeBtn.addEventListener('click', () => appScreen.classList.add('hidden'));\r\n        if (closeSettingsBtn) closeSettingsBtn.addEventListener('click', () => settingsAppScreen.classList.add('hidden'));\r\n        if (closeWechatBtn) closeWechatBtn.addEventListener('click', () => wechatAppScreen.classList.add('hidden'));\r\n        if (closeWorldbookBtn) closeWorldbookBtn.addEventListener('click', () => worldbookAppScreen.classList.add('hidden'));\r\n\r\n        // 微信底栏切换\r\n        const wechatTabs = document.querySelectorAll('.wechat-tab-item');\r\n        const addContactBtn = document.getElementById('wechat-add-contact');\r\n\r\n        wechatTabs.forEach(tab => {\r\n            tab.addEventListener('click', () => {\r\n                wechatTabs.forEach(t => t.classList.remove('active'));\r\n                document.querySelectorAll('.wechat-tab-content').forEach(c => c.classList.remove('active'));\r\n                \r\n                tab.classList.add('active');\r\n                document.getElementById(`wechat-tab-${tab.dataset.tab}`).classList.add('active');\r\n\r\n                // 控制右上角按钮显示\r\n                if (tab.dataset.tab === 'contacts') {\r\n                    addContactBtn.style.display = 'block';\r\n                } else {\r\n                    addContactBtn.style.display = 'none';\r\n                }\r\n            });\r\n        });\r\n\r\n        // 微信添加联系人\r\n        const addContactModal = document.getElementById('add-contact-modal');\r\n        const closeAddContactBtn = document.getElementById('close-add-contact');\r\n        const saveContactBtn = document.getElementById('save-contact-btn');\r\n\r\n        if (addContactBtn) addContactBtn.addEventListener('click', () => addContactModal.classList.remove('hidden'));\r\n        if (closeAddContactBtn) closeAddContactBtn.addEventListener('click', () => addContactModal.classList.add('hidden'));\r\n        if (saveContactBtn) saveContactBtn.addEventListener('click', handleSaveContact);\r\n\r\n        // 微信聊天页面返回\r\n        const backToContactsBtn = document.getElementById('back-to-contacts');\r\n        if (backToContactsBtn) backToContactsBtn.addEventListener('click', () => {\r\n            document.getElementById('chat-screen').classList.add('hidden');\r\n            state.currentChatContactId = null;\r\n        });\r\n\r\n        // 聊天设置\r\n        const chatSettingsBtn = document.getElementById('chat-settings-btn');\r\n        const chatSettingsScreen = document.getElementById('chat-settings-screen');\r\n        const closeChatSettingsBtn = document.getElementById('close-chat-settings');\r\n        const saveChatSettingsBtn = document.getElementById('save-chat-settings-btn');\r\n        const triggerAiMomentBtn = document.getElementById('trigger-ai-moment-btn');\r\n\r\n        if (chatSettingsBtn) chatSettingsBtn.addEventListener('click', openChatSettings);\r\n        if (closeChatSettingsBtn) closeChatSettingsBtn.addEventListener('click', () => chatSettingsScreen.classList.add('hidden'));\r\n        if (saveChatSettingsBtn) saveChatSettingsBtn.addEventListener('click', handleSaveChatSettings);\r\n        if (triggerAiMomentBtn) triggerAiMomentBtn.addEventListener('click', () => generateAiMoment(false));\r\n\r\n        const clearChatHistoryBtn = document.getElementById('clear-chat-history-btn');\r\n        if (clearChatHistoryBtn) clearChatHistoryBtn.addEventListener('click', handleClearChatHistory);\r\n\r\n        // 聊天输入\r\n        const chatInput = document.getElementById('chat-input');\r\n        const triggerAiReplyBtn = document.getElementById('trigger-ai-reply-btn');\r\n\r\n        if (chatInput) {\r\n            chatInput.addEventListener('keydown', (e) => {\r\n                if (e.key === 'Enter') {\r\n                    const text = chatInput.value.trim();\r\n                    if (text) {\r\n                        sendMessage(text, true);\r\n                        chatInput.value = '';\r\n                    }\r\n                }\r\n            });\r\n        }\r\n\r\n        if (triggerAiReplyBtn) {\r\n            triggerAiReplyBtn.addEventListener('click', generateAiReply);\r\n        }\r\n\r\n        // 世界书相关\r\n        const addWorldbookEntryBtn = document.getElementById('add-worldbook-entry');\r\n        const worldbookEditModal = document.getElementById('worldbook-edit-modal');\r\n        const closeWorldbookEditBtn = document.getElementById('close-worldbook-edit');\r\n        const saveWorldbookBtn = document.getElementById('save-worldbook-btn');\r\n        const deleteWorldbookBtn = document.getElementById('delete-worldbook-btn');\r\n\r\n        if (addWorldbookEntryBtn) addWorldbookEntryBtn.addEventListener('click', () => openWorldbookEdit());\r\n        if (closeWorldbookEditBtn) closeWorldbookEditBtn.addEventListener('click', () => worldbookEditModal.classList.add('hidden'));\r\n        if (saveWorldbookBtn) saveWorldbookBtn.addEventListener('click', handleSaveWorldbookEntry);\r\n        if (deleteWorldbookBtn) deleteWorldbookBtn.addEventListener('click', handleDeleteWorldbookEntry);\r\n\r\n        // 字体相关\r\n        const fontUpload = document.getElementById('font-upload');\r\n        if (fontUpload) fontUpload.addEventListener('change', handleFontUpload);\r\n        \r\n        const applyFontUrlBtn = document.getElementById('apply-font-url');\r\n        if (applyFontUrlBtn) applyFontUrlBtn.addEventListener('click', handleFontUrl);\r\n        \r\n        // 字体预设相关\r\n        const saveFontPresetBtn = document.getElementById('save-font-preset');\r\n        if (saveFontPresetBtn) saveFontPresetBtn.addEventListener('click', handleSaveFontPreset);\r\n        \r\n        const deleteFontPresetBtn = document.getElementById('delete-font-preset');\r\n        if (deleteFontPresetBtn) deleteFontPresetBtn.addEventListener('click', handleDeleteFontPreset);\r\n        \r\n        const fontPresetSelect = document.getElementById('font-preset-select');\r\n        if (fontPresetSelect) fontPresetSelect.addEventListener('change', handleApplyFontPreset);\r\n\r\n        // 壁纸相关\r\n        const wallpaperUpload = document.getElementById('wallpaper-upload');\r\n        if (wallpaperUpload) wallpaperUpload.addEventListener('change', handleWallpaperUpload);\r\n        \r\n        const resetWallpaperBtn = document.getElementById('reset-wallpaper');\r\n        if (resetWallpaperBtn) {\r\n            resetWallpaperBtn.addEventListener('click', () => {\r\n                state.currentWallpaper = null;\r\n                applyWallpaper(null);\r\n                saveConfig();\r\n                renderWallpaperGallery();\r\n            });\r\n        }\r\n\r\n        // 图标相关\r\n        const resetIconsBtn = document.getElementById('reset-icons');\r\n        if (resetIconsBtn) {\r\n            resetIconsBtn.addEventListener('click', () => {\r\n                state.icons = {};\r\n                applyIcons();\r\n                saveConfig();\r\n                renderIconSettings();\r\n            });\r\n        }\r\n\r\n        // CSS相关\r\n        const saveCssBtn = document.getElementById('save-css');\r\n        if (saveCssBtn) {\r\n            saveCssBtn.addEventListener('click', () => {\r\n                state.css = document.getElementById('css-editor').value;\r\n                applyCSS(state.css);\r\n                saveConfig();\r\n                alert('CSS配置已保存');\r\n            });\r\n        }\r\n        \r\n        const exportCssBtn = document.getElementById('export-css');\r\n        if (exportCssBtn) exportCssBtn.addEventListener('click', exportCSS);\r\n\r\n        // CSS预设相关\r\n        const saveCssPresetBtn = document.getElementById('save-css-preset');\r\n        if (saveCssPresetBtn) saveCssPresetBtn.addEventListener('click', handleSaveCssPreset);\r\n        \r\n        const deleteCssPresetBtn = document.getElementById('delete-css-preset');\r\n        if (deleteCssPresetBtn) deleteCssPresetBtn.addEventListener('click', handleDeleteCssPreset);\r\n        \r\n        const cssPresetSelect = document.getElementById('css-preset-select');\r\n        if (cssPresetSelect) cssPresetSelect.addEventListener('change', handleApplyCssPreset);\r\n\r\n        // AI 设置相关 (主)\r\n        setupAiListeners(false);\r\n        \r\n        // AI 设置相关 (副)\r\n        setupAiListeners(true);\r\n\r\n        // 保存所有配置\r\n        const saveAllSettingsBtn = document.getElementById('save-all-settings');\r\n        if (saveAllSettingsBtn) {\r\n            saveAllSettingsBtn.addEventListener('click', () => {\r\n                saveConfig();\r\n                alert('所有配置已保存');\r\n            });\r\n        }\r\n\r\n        // 身份管理相关\r\n        const switchPersonaBtn = document.getElementById('switch-persona-btn');\r\n        const closePersonaManageBtn = document.getElementById('close-persona-manage');\r\n        const addPersonaBtn = document.getElementById('add-persona-btn');\r\n        const closePersonaEditBtn = document.getElementById('close-persona-edit');\r\n        const savePersonaBtn = document.getElementById('save-persona-btn');\r\n        const deletePersonaBtn = document.getElementById('delete-persona-btn');\r\n\r\n        if (switchPersonaBtn) switchPersonaBtn.addEventListener('click', openPersonaManage);\r\n        if (closePersonaManageBtn) closePersonaManageBtn.addEventListener('click', () => document.getElementById('persona-manage-modal').classList.add('hidden'));\r\n        if (addPersonaBtn) addPersonaBtn.addEventListener('click', () => {\r\n            document.getElementById('persona-manage-modal').classList.add('hidden');\r\n            openPersonaEdit(null);\r\n        });\r\n        if (closePersonaEditBtn) closePersonaEditBtn.addEventListener('click', () => document.getElementById('persona-edit-modal').classList.add('hidden'));\r\n        if (savePersonaBtn) savePersonaBtn.addEventListener('click', handleSavePersona);\r\n        if (deletePersonaBtn) deletePersonaBtn.addEventListener('click', handleDeletePersona);\r\n\r\n        // 数据管理\r\n        const saveConfigBtn = document.getElementById('save-config');\r\n        if (saveConfigBtn) {\r\n            saveConfigBtn.addEventListener('click', () => {\r\n                saveConfig();\r\n                alert('配置已保存');\r\n            });\r\n        }\r\n        \r\n        const loadConfigBtn = document.getElementById('load-config');\r\n        if (loadConfigBtn) {\r\n            loadConfigBtn.addEventListener('click', () => {\r\n                loadConfig();\r\n                alert('配置已加载');\r\n            });\r\n        }\r\n        \r\n        const exportJsonBtn = document.getElementById('export-json');\r\n        if (exportJsonBtn) exportJsonBtn.addEventListener('click', exportJSON);\r\n        \r\n        const importJsonInput = document.getElementById('import-json');\r\n        if (importJsonInput) importJsonInput.addEventListener('change', importJSON);\r\n\r\n        // 朋友圈背景上传\r\n        const momentsBgInput = document.getElementById('moments-bg-input');\r\n        if (momentsBgInput) momentsBgInput.addEventListener('change', (e) => handleMeImageUpload(e, 'momentsBgImage'));\r\n\r\n        // 发布动态相关\r\n        const addMomentBtn = document.getElementById('add-moment-btn');\r\n        const postMomentModal = document.getElementById('post-moment-modal');\r\n        const closePostMomentBtn = document.getElementById('close-post-moment');\r\n        const doPostMomentBtn = document.getElementById('do-post-moment');\r\n        const addMomentImageBtn = document.getElementById('add-moment-image-btn');\r\n        const postMomentFileInput = document.getElementById('post-moment-file-input');\r\n\r\n        if (addMomentBtn) {\r\n            // 长按发文字\r\n            let pressTimer;\r\n            addMomentBtn.addEventListener('mousedown', () => {\r\n                pressTimer = setTimeout(() => {\r\n                    openPostMoment(true); // 纯文字模式\r\n                }, 800);\r\n            });\r\n            addMomentBtn.addEventListener('mouseup', () => clearTimeout(pressTimer));\r\n            addMomentBtn.addEventListener('touchstart', () => {\r\n                pressTimer = setTimeout(() => {\r\n                    openPostMoment(true); // 纯文字模式\r\n                }, 800);\r\n            });\r\n            addMomentBtn.addEventListener('touchend', () => clearTimeout(pressTimer));\r\n            \r\n            // 点击发图文\r\n            addMomentBtn.addEventListener('click', (e) => {\r\n                if (e.detail === 1) { // 区分点击和长按\r\n                    openPostMoment(false);\r\n                }\r\n            });\r\n        }\r\n\r\n        if (closePostMomentBtn) closePostMomentBtn.addEventListener('click', () => postMomentModal.classList.add('hidden'));\r\n        if (doPostMomentBtn) doPostMomentBtn.addEventListener('click', handlePostMoment);\r\n        if (addMomentImageBtn) addMomentImageBtn.addEventListener('click', () => postMomentFileInput.click());\r\n        if (postMomentFileInput) postMomentFileInput.addEventListener('change', handlePostMomentImages);\r\n    }\r\n\r\n    let postMomentImages = [];\r\n\r\n    function openPostMoment(isTextOnly) {\r\n        const modal = document.getElementById('post-moment-modal');\r\n        const textInput = document.getElementById('post-moment-text');\r\n        const imageContainer = document.getElementById('post-moment-images');\r\n        \r\n        textInput.value = '';\r\n        postMomentImages = [];\r\n        renderPostMomentImages();\r\n        \r\n        if (isTextOnly) {\r\n            imageContainer.style.display = 'none';\r\n            textInput.placeholder = '这一刻的想法...';\r\n        } else {\r\n            imageContainer.style.display = 'grid';\r\n            textInput.placeholder = '这一刻的想法...';\r\n        }\r\n        \r\n        modal.classList.remove('hidden');\r\n    }\r\n\r\n    function handlePostMomentImages(e) {\r\n        const files = Array.from(e.target.files);\r\n        if (files.length === 0) return;\r\n\r\n        files.forEach(file => {\r\n            const reader = new FileReader();\r\n            reader.onload = (event) => {\r\n                if (postMomentImages.length < 9) {\r\n                    postMomentImages.push(event.target.result);\r\n                    renderPostMomentImages();\r\n                }\r\n            };\r\n            reader.readAsDataURL(file);\r\n        });\r\n        e.target.value = '';\r\n    }\r\n\r\n    function renderPostMomentImages() {\r\n        const container = document.getElementById('post-moment-images');\r\n        const addBtn = document.getElementById('add-moment-image-btn');\r\n        \r\n        // 清除旧的图片预览（保留添加按钮）\r\n        const oldItems = container.querySelectorAll('.post-image-item');\r\n        oldItems.forEach(item => item.remove());\r\n        \r\n        postMomentImages.forEach((imgSrc, index) => {\r\n            const item = document.createElement('div');\r\n            item.className = 'post-image-item';\r\n            item.innerHTML = `<img src=\"${imgSrc}\">`;\r\n            container.insertBefore(item, addBtn);\r\n        });\r\n\r\n        if (postMomentImages.length >= 9) {\r\n            addBtn.style.display = 'none';\r\n        } else {\r\n            addBtn.style.display = 'flex';\r\n        }\r\n    }\r\n\r\n    function handlePostMoment() {\r\n        const content = document.getElementById('post-moment-text').value.trim();\r\n        \r\n        if (!content && postMomentImages.length === 0) {\r\n            alert('请输入内容或选择图片');\r\n            return;\r\n        }\r\n\r\n        addMoment('me', content, [...postMomentImages]);\r\n\r\n        // 同步动态发布信息到所有联系人的聊天记录（隐藏消息）\r\n        // 这样AI在任何聊天中都能知道用户发了动态\r\n        const momentSummary = content || '[图片动态]';\r\n        const imageTag = postMomentImages.length > 0 ? ` [包含${postMomentImages.length}张图片]` : '';\r\n        const hiddenMsg = `[发布了动态]: ${momentSummary}${imageTag}`;\r\n\r\n        state.contacts.forEach(contact => {\r\n            if (!state.chatHistory[contact.id]) {\r\n                state.chatHistory[contact.id] = [];\r\n            }\r\n            state.chatHistory[contact.id].push({\r\n                role: 'user',\r\n                content: hiddenMsg\r\n            });\r\n        });\r\n        \r\n        // 如果当前在聊天界面，且该消息是隐藏的，不需要更新UI，但需要保存\r\n        saveConfig();\r\n\r\n        document.getElementById('post-moment-modal').classList.add('hidden');\r\n    }\r\n\r\n    function setupAiListeners(isSecondary) {\r\n        const suffix = isSecondary ? '-2' : '';\r\n        const settingsKey = isSecondary ? 'aiSettings2' : 'aiSettings';\r\n        \r\n        const aiApiUrl = document.getElementById(`ai-api-url${suffix}`);\r\n        if (aiApiUrl) aiApiUrl.addEventListener('change', (e) => {\r\n            state[settingsKey].url = e.target.value;\r\n        });\r\n\r\n        const aiApiKey = document.getElementById(`ai-api-key${suffix}`);\r\n        if (aiApiKey) aiApiKey.addEventListener('change', (e) => {\r\n            state[settingsKey].key = e.target.value;\r\n        });\r\n\r\n        const fetchModelsBtn = document.getElementById(`fetch-models${suffix}`);\r\n        if (fetchModelsBtn) fetchModelsBtn.addEventListener('click', () => handleFetchModels(isSecondary));\r\n\r\n        const aiModelSelect = document.getElementById(`ai-model-select${suffix}`);\r\n        if (aiModelSelect) aiModelSelect.addEventListener('change', (e) => {\r\n            state[settingsKey].model = e.target.value;\r\n        });\r\n\r\n        const aiTemperature = document.getElementById(`ai-temperature${suffix}`);\r\n        if (aiTemperature) aiTemperature.addEventListener('input', (e) => {\r\n            state[settingsKey].temperature = parseFloat(e.target.value);\r\n            document.getElementById(`ai-temp-value${suffix}`).textContent = state[settingsKey].temperature;\r\n        });\r\n\r\n        // AI 预设相关\r\n        const saveAiPresetBtn = document.getElementById(`save-ai-preset${suffix}`);\r\n        if (saveAiPresetBtn) saveAiPresetBtn.addEventListener('click', () => handleSaveAiPreset(isSecondary));\r\n\r\n        const deleteAiPresetBtn = document.getElementById(`delete-ai-preset${suffix}`);\r\n        if (deleteAiPresetBtn) deleteAiPresetBtn.addEventListener('click', () => handleDeleteAiPreset(isSecondary));\r\n\r\n        const aiPresetSelect = document.getElementById(`ai-preset-select${suffix}`);\r\n        if (aiPresetSelect) aiPresetSelect.addEventListener('change', (e) => handleApplyAiPreset(e, isSecondary));\r\n    }\r\n\r\n    // --- 身份管理功能 ---\r\n\r\n    let currentEditingPersonaId = null;\r\n\r\n    function renderMeTab() {\r\n        const container = document.getElementById('me-profile-container');\r\n        if (!container) return;\r\n\r\n        // 确保 userProfile 存在\r\n        if (!state.userProfile) {\r\n            state.userProfile = {\r\n                name: 'User Name',\r\n                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix',\r\n                bgImage: '',\r\n                desc: '点击此处添加个性签名',\r\n                wxid: 'wxid_123456'\r\n            };\r\n        }\r\n\r\n        const { name, wxid, avatar, bgImage, desc } = state.userProfile;\r\n        const bg = bgImage || '';\r\n\r\n        container.innerHTML = `\r\n            <div class=\"me-profile-card\">\r\n                <div class=\"me-bg\" id=\"me-bg-trigger\" style=\"background-image: url('${bg}'); background-color: ${bg ? 'transparent' : '#ccc'};\"></div>\r\n                <div class=\"me-info\">\r\n                    <div class=\"me-avatar-row\">\r\n                        <img class=\"me-avatar\" id=\"me-avatar-trigger\" src=\"${avatar}\">\r\n                    </div>\r\n                    <div class=\"me-name\" id=\"me-name-trigger\">${name}</div>\r\n                    <div class=\"me-id\">微信号：<span id=\"me-id-trigger\">${wxid}</span></div>\r\n                    <div class=\"me-desc\" id=\"me-desc-trigger\">${desc}</div>\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        // 绑定事件\r\n        const avatarInput = document.getElementById('me-avatar-input');\r\n        const bgInput = document.getElementById('me-bg-input');\r\n\r\n        document.getElementById('me-avatar-trigger').addEventListener('click', () => avatarInput.click());\r\n        document.getElementById('me-bg-trigger').addEventListener('click', () => bgInput.click());\r\n\r\n        avatarInput.onchange = (e) => handleMeImageUpload(e, 'avatar');\r\n        bgInput.onchange = (e) => handleMeImageUpload(e, 'bgImage');\r\n\r\n        makeEditable('me-name-trigger', 'name');\r\n        makeEditable('me-id-trigger', 'wxid');\r\n        makeEditable('me-desc-trigger', 'desc');\r\n    }\r\n\r\n    function handleMeImageUpload(e, type) {\r\n        const file = e.target.files[0];\r\n        if (!file) return;\r\n        \r\n        const reader = new FileReader();\r\n        reader.onload = (event) => {\r\n            updateUserProfile(type, event.target.result);\r\n        };\r\n        reader.readAsDataURL(file);\r\n        e.target.value = ''; // 重置，允许重复选择同一文件\r\n    }\r\n\r\n    function makeEditable(elementId, field) {\r\n        const el = document.getElementById(elementId);\r\n        el.addEventListener('click', () => {\r\n            const currentText = el.textContent;\r\n            const input = document.createElement(field === 'desc' ? 'textarea' : 'input');\r\n            input.value = currentText === '点击此处添加个性签名' ? '' : currentText;\r\n            input.className = 'editable-input'; // 需要在CSS中定义，或者内联样式\r\n            input.style.width = '100%';\r\n            input.style.fontSize = 'inherit';\r\n            input.style.fontFamily = 'inherit';\r\n            \r\n            el.replaceWith(input);\r\n            input.focus();\r\n\r\n            const save = () => {\r\n                const newValue = input.value.trim();\r\n                updateUserProfile(field, newValue);\r\n                // renderMeTab 会重新渲染，所以不需要手动替换回 div\r\n            };\r\n\r\n            input.addEventListener('blur', save);\r\n            input.addEventListener('keydown', (e) => {\r\n                if (e.key === 'Enter' && field !== 'desc') {\r\n                    save();\r\n                }\r\n            });\r\n        });\r\n    }\r\n\r\n    function updateUserProfile(field, value) {\r\n        if (!state.userProfile) {\r\n            state.userProfile = {\r\n                name: 'User Name',\r\n                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix',\r\n                bgImage: '',\r\n                momentsBgImage: '',\r\n                desc: '点击此处添加个性签名',\r\n                wxid: 'wxid_123456'\r\n            };\r\n        }\r\n        state.userProfile[field] = value;\r\n        saveConfig();\r\n        renderMeTab();\r\n        renderMoments();\r\n    }\r\n\r\n    function renderMoments() {\r\n        const container = document.getElementById('moments-container');\r\n        if (!container) return;\r\n\r\n        // 确保 userProfile 存在\r\n        if (!state.userProfile) {\r\n            state.userProfile = {\r\n                name: 'User Name',\r\n                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix',\r\n                bgImage: '',\r\n                momentsBgImage: '',\r\n                desc: '点击此处添加个性签名',\r\n                wxid: 'wxid_123456'\r\n            };\r\n        }\r\n\r\n        const { name, avatar, momentsBgImage, desc } = state.userProfile;\r\n        const bg = momentsBgImage || '';\r\n\r\n        // 检查是否已经渲染过结构\r\n        const coverEl = document.getElementById('moments-cover-trigger');\r\n        if (coverEl) {\r\n            // 更新内容\r\n            coverEl.style.backgroundImage = `url('${bg}')`;\r\n            coverEl.style.backgroundColor = ''; // 移除内联背景色，交由CSS控制\r\n            \r\n            document.getElementById('moments-user-name').textContent = name;\r\n            document.getElementById('moments-user-avatar').src = avatar;\r\n        } else {\r\n            // 首次渲染\r\n            container.innerHTML = `\r\n                <div class=\"moments-header\">\r\n                    <div class=\"moments-cover\" id=\"moments-cover-trigger\" style=\"background-image: url('${bg}');\">\r\n                        <div class=\"moments-user-info\">\r\n                            <span class=\"moments-user-name\" id=\"moments-user-name\">${name}</span>\r\n                            <img class=\"moments-user-avatar\" id=\"moments-user-avatar\" src=\"${avatar}\">\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"moments-list\" id=\"moments-list-content\">\r\n                    <!-- 朋友圈列表内容 -->\r\n                </div>\r\n            `;\r\n            \r\n            // 绑定事件\r\n            document.getElementById('moments-cover-trigger').addEventListener('click', () => {\r\n                document.getElementById('moments-bg-input').click();\r\n            });\r\n        }\r\n\r\n        renderMomentsList();\r\n    }\r\n\r\n    function renderMomentsList() {\r\n        const listContainer = document.getElementById('moments-list-content');\r\n        if (!listContainer) return;\r\n\r\n        listContainer.innerHTML = '';\r\n\r\n        if (!state.moments) state.moments = [];\r\n\r\n        // 按时间倒序\r\n        const sortedMoments = [...state.moments].sort((a, b) => b.time - a.time);\r\n\r\n        sortedMoments.forEach(moment => {\r\n            let avatar, name;\r\n            \r\n            if (moment.contactId === 'me') {\r\n                avatar = state.userProfile.avatar;\r\n                name = state.userProfile.name;\r\n            } else {\r\n                const contact = state.contacts.find(c => c.id === moment.contactId);\r\n                if (contact) {\r\n                    avatar = contact.avatar;\r\n                    name = contact.remark || contact.name;\r\n                } else {\r\n                    avatar = 'https://api.dicebear.com/7.x/avataaars/svg?seed=Unknown';\r\n                    name = '未知用户';\r\n                }\r\n            }\r\n\r\n            const item = document.createElement('div');\r\n            item.className = 'moment-item';\r\n            \r\n            // 图片HTML\r\n            let imagesHtml = '';\r\n            if (moment.images && moment.images.length > 0) {\r\n                const gridClass = moment.images.length === 1 ? 'single' : 'grid';\r\n                imagesHtml = `<div class=\"moment-images ${gridClass}\">\r\n                    ${moment.images.map(img => `<img src=\"${img}\" class=\"moment-img\">`).join('')}\r\n                </div>`;\r\n            }\r\n\r\n            // 点赞列表HTML\r\n            let likesHtml = '';\r\n            if (moment.likes && moment.likes.length > 0) {\r\n                likesHtml = `<div class=\"moment-likes\"><i class=\"far fa-heart\"></i> ${moment.likes.join(', ')}</div>`;\r\n            }\r\n\r\n            // 评论列表HTML\r\n            let commentsHtml = '';\r\n            if (moment.comments && moment.comments.length > 0) {\r\n                commentsHtml = `<div class=\"moment-comments\">\r\n                    ${moment.comments.map((c, index) => {\r\n                        let userHtml = `<span class=\"comment-user\">${c.user}</span>`;\r\n                        if (c.replyTo) {\r\n                            userHtml += `回复<span class=\"comment-user\">${c.replyTo}</span>`;\r\n                        }\r\n                        return `<div class=\"comment-item\" onclick=\"event.stopPropagation(); window.handleCommentClick(this, ${moment.id}, ${index}, '${c.user}')\" style=\"display: flex; justify-content: space-between; align-items: flex-start; cursor: pointer; padding: 2px 4px; border-radius: 2px;\">\r\n                            <span style=\"flex: 1;\">${userHtml}：<span class=\"comment-content\">${c.content}</span></span>\r\n                            <span class=\"comment-delete-btn\" style=\"display: none; color: #576b95; margin-left: 8px; font-size: 12px; padding: 0 4px;\">✕</span>\r\n                        </div>`;\r\n                    }).join('')}\r\n                </div>`;\r\n            }\r\n\r\n            // 底部区域HTML\r\n            let footerHtml = '';\r\n            if (likesHtml || commentsHtml) {\r\n                footerHtml = `<div class=\"moment-likes-comments\">${likesHtml}${commentsHtml}</div>`;\r\n            }\r\n\r\n            // 时间格式化 (简单处理)\r\n            const date = new Date(moment.time);\r\n            const timeStr = `${date.getMonth() + 1}月${date.getDate()}日 ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;\r\n\r\n            item.innerHTML = `\r\n                <img src=\"${avatar}\" class=\"moment-avatar\">\r\n                <div class=\"moment-content\">\r\n                    <div class=\"moment-name\">${name}</div>\r\n                    <div class=\"moment-text\">${moment.content}</div>\r\n                    ${imagesHtml}\r\n                    <div class=\"moment-info\">\r\n                        <div style=\"display: flex; align-items: center;\">\r\n                            <span class=\"moment-time\">${timeStr}</span>\r\n                            <span class=\"moment-delete\" onclick=\"window.deleteMoment(${moment.id})\">删除</span>\r\n                        </div>\r\n                        <div style=\"position: relative;\">\r\n                            <button class=\"moment-action-btn\" onclick=\"window.toggleActionMenu(this, ${moment.id})\"><i class=\"fas fa-ellipsis-h\"></i></button>\r\n                            <div class=\"action-menu\" id=\"action-menu-${moment.id}\">\r\n                                <button class=\"action-menu-btn\" onclick=\"window.toggleLike(${moment.id})\"><i class=\"far fa-heart\"></i> 赞</button>\r\n                                <button class=\"action-menu-btn\" onclick=\"window.showCommentInput(${moment.id})\"><i class=\"far fa-comment\"></i> 评论</button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    ${footerHtml}\r\n                </div>\r\n            `;\r\n            \r\n            listContainer.appendChild(item);\r\n        });\r\n    }\r\n\r\n    window.deleteMoment = function(id) {\r\n        if (confirm('确定删除这条动态吗？')) {\r\n            state.moments = state.moments.filter(m => m.id !== id);\r\n            saveConfig();\r\n            renderMomentsList();\r\n        }\r\n    };\r\n\r\n    window.handleCommentClick = function(el, momentId, index, user) {\r\n        const deleteBtn = el.querySelector('.comment-delete-btn');\r\n        \r\n        // 检查是否已经显示\r\n        if (deleteBtn.style.display !== 'none') {\r\n            // 已经显示了，再次点击 -> 回复\r\n            window.replyToComment(momentId, user);\r\n        } else {\r\n            // 未显示 -> 显示删除按钮，隐藏其他的\r\n            document.querySelectorAll('.comment-delete-btn').forEach(btn => btn.style.display = 'none');\r\n            document.querySelectorAll('.comment-item').forEach(item => item.style.backgroundColor = '');\r\n            \r\n            deleteBtn.style.display = 'inline-block';\r\n            el.style.backgroundColor = '#e5e5e5'; // 选中背景\r\n            \r\n            // 绑定删除事件\r\n            deleteBtn.onclick = function(e) {\r\n                e.stopPropagation();\r\n                window.deleteComment(momentId, index);\r\n            };\r\n            \r\n            // 点击其他地方隐藏\r\n            const closeDelete = () => {\r\n                deleteBtn.style.display = 'none';\r\n                el.style.backgroundColor = '';\r\n                document.removeEventListener('click', closeDelete);\r\n            };\r\n            setTimeout(() => document.addEventListener('click', closeDelete), 0);\r\n        }\r\n    };\r\n\r\n    window.deleteComment = function(momentId, commentIndex) {\r\n        if (confirm('确定删除这条评论吗？')) {\r\n            const moment = state.moments.find(m => m.id === momentId);\r\n            if (moment && moment.comments) {\r\n                moment.comments.splice(commentIndex, 1);\r\n                saveConfig();\r\n                renderMomentsList();\r\n            }\r\n        }\r\n    };\r\n\r\n    window.toggleActionMenu = function(btn, id) {\r\n        // 关闭其他打开的菜单\r\n        document.querySelectorAll('.action-menu.show').forEach(el => {\r\n            if (el.id !== `action-menu-${id}`) el.classList.remove('show');\r\n        });\r\n        \r\n        const menu = document.getElementById(`action-menu-${id}`);\r\n        menu.classList.toggle('show');\r\n        \r\n        // 点击其他地方关闭\r\n        const closeMenu = (e) => {\r\n            if (!btn.contains(e.target) && !menu.contains(e.target)) {\r\n                menu.classList.remove('show');\r\n                document.removeEventListener('click', closeMenu);\r\n            }\r\n        };\r\n        setTimeout(() => document.addEventListener('click', closeMenu), 0);\r\n    };\r\n\r\n    window.toggleLike = function(id, userName = null) {\r\n        const moment = state.moments.find(m => m.id === id);\r\n        if (!moment) return;\r\n\r\n        if (!moment.likes) moment.likes = [];\r\n        \r\n        const likerName = userName || state.userProfile.name;\r\n        const index = moment.likes.indexOf(likerName);\r\n        \r\n        if (index > -1) {\r\n            moment.likes.splice(index, 1);\r\n        } else {\r\n            moment.likes.push(likerName);\r\n        }\r\n        \r\n        saveConfig();\r\n        renderMomentsList();\r\n    };\r\n\r\n    window.showCommentInput = function(id) {\r\n        const content = prompt('请输入评论内容：');\r\n        if (content) {\r\n            window.submitComment(id, content);\r\n        }\r\n        // 关闭菜单\r\n        const menu = document.getElementById(`action-menu-${id}`);\r\n        if (menu) menu.classList.remove('show');\r\n    };\r\n\r\n    window.replyToComment = function(momentId, toUser) {\r\n        if (toUser === state.userProfile.name) {\r\n            alert('不能回复自己');\r\n            return;\r\n        }\r\n        const content = prompt(`回复 ${toUser}：`);\r\n        if (content) {\r\n            window.submitComment(momentId, content, toUser);\r\n        }\r\n    };\r\n\r\n    window.submitComment = function(id, content, replyTo = null, userName = null) {\r\n        const moment = state.moments.find(m => m.id === id);\r\n        if (!moment) return;\r\n\r\n        if (!moment.comments) moment.comments = [];\r\n        \r\n        const commenterName = userName || state.userProfile.name;\r\n\r\n        moment.comments.push({\r\n            user: commenterName,\r\n            content: content,\r\n            replyTo: replyTo\r\n        });\r\n\r\n        // 同步到聊天记录 (如果是用户评论AI的动态)\r\n        if (moment.contactId !== 'me' && !userName) {\r\n            const contactId = moment.contactId;\r\n            // 截取动态内容防止过长\r\n            let momentText = moment.content;\r\n            if (momentText.length > 50) momentText = momentText.substring(0, 50) + '...';\r\n            \r\n            let chatMsg = `[评论了你的动态: \"${momentText}\"] ${content}`;\r\n            if (replyTo) {\r\n                chatMsg = `[评论了你的动态: \"${momentText}\"] (回复 ${replyTo}) ${content}`;\r\n            }\r\n            \r\n            if (!state.chatHistory[contactId]) {\r\n                state.chatHistory[contactId] = [];\r\n            }\r\n            state.chatHistory[contactId].push({\r\n                role: 'user',\r\n                content: chatMsg\r\n            });\r\n            \r\n            // 如果当前正在该聊天窗口，更新UI\r\n            if (state.currentChatContactId === contactId) {\r\n                appendMessageToUI(chatMsg, true);\r\n                scrollToBottom();\r\n            }\r\n        }\r\n        \r\n        saveConfig();\r\n        renderMomentsList();\r\n\r\n        // 触发AI回复评论 (如果是AI发的动态，且不是AI自己评论的)\r\n        if (moment.contactId !== 'me' && !userName) {\r\n            setTimeout(() => {\r\n                generateAiCommentReply(moment, { user: state.userProfile.name, content: content, replyTo: replyTo });\r\n            }, 2000);\r\n        }\r\n    };\r\n\r\n    async function generateAiCommentReply(moment, userComment) {\r\n        const contact = state.contacts.find(c => c.id === moment.contactId);\r\n        if (!contact) return;\r\n\r\n        const settings = state.aiSettings.url ? state.aiSettings : state.aiSettings2;\r\n        if (!settings.url || !settings.key) return;\r\n\r\n        try {\r\n            let contextDesc = `你的朋友 ${userComment.user} 在下面评论说：“${userComment.content}”`;\r\n            if (userComment.replyTo) {\r\n                contextDesc = `你的朋友 ${userComment.user} 回复了 ${userComment.replyTo} 说：“${userComment.content}”`;\r\n            }\r\n\r\n            let systemPrompt = `你现在扮演 ${contact.name}。\r\n人设：${contact.persona || '无'}\r\n\r\n【当前情境】\r\n你发了一条朋友圈：“${moment.content}”\r\n${contextDesc}\r\n\r\n【任务】\r\n请回复 ${userComment.user}。\r\n回复要求：\r\n1. 简短自然，像微信朋友圈回复。\r\n2. 符合你的人设。\r\n3. 直接返回回复内容，不要包含任何解释。`;\r\n\r\n            let fetchUrl = settings.url;\r\n            if (!fetchUrl.endsWith('/chat/completions')) {\r\n                fetchUrl = fetchUrl.endsWith('/') ? fetchUrl + 'chat/completions' : fetchUrl + '/chat/completions';\r\n            }\r\n\r\n            const response = await fetch(fetchUrl, {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    'Authorization': `Bearer ${settings.key}`\r\n                },\r\n                body: JSON.stringify({\r\n                    model: settings.model,\r\n                    messages: [\r\n                        { role: 'system', content: systemPrompt },\r\n                        { role: 'user', content: '请回复' }\r\n                    ],\r\n                    temperature: 0.7\r\n                })\r\n            });\r\n\r\n            if (!response.ok) return;\r\n\r\n            const data = await response.json();\r\n            let replyContent = data.choices[0].message.content.trim();\r\n            \r\n            // 去除可能的引号\r\n            if ((replyContent.startsWith('\"') && replyContent.endsWith('\"')) || (replyContent.startsWith('“') && replyContent.endsWith('”'))) {\r\n                replyContent = replyContent.slice(1, -1);\r\n            }\r\n\r\n            // 添加回复到评论列表\r\n            if (!moment.comments) moment.comments = [];\r\n            moment.comments.push({\r\n                user: contact.remark || contact.name,\r\n                content: replyContent,\r\n                replyTo: userComment.user\r\n            });\r\n            \r\n            saveConfig();\r\n            renderMomentsList();\r\n\r\n        } catch (error) {\r\n            console.error('AI回复评论失败:', error);\r\n        }\r\n    }\r\n\r\n    function addMoment(contactId, content, images = []) {\r\n        if (!state.moments) state.moments = [];\r\n        \r\n        const newMoment = {\r\n            id: Date.now(),\r\n            contactId,\r\n            content,\r\n            images,\r\n            time: Date.now(),\r\n            likes: [],\r\n            comments: []\r\n        };\r\n        \r\n        state.moments.unshift(newMoment);\r\n        saveConfig();\r\n        renderMomentsList();\r\n    }\r\n\r\n    async function generateAiMoment(isSilent = false) {\r\n        if (!state.currentChatContactId) {\r\n            if (!isSilent) alert('请先进入一个聊天窗口');\r\n            return;\r\n        }\r\n        \r\n        const contact = state.contacts.find(c => c.id === state.currentChatContactId);\r\n        if (!contact) return;\r\n\r\n        const settings = state.aiSettings.url ? state.aiSettings : state.aiSettings2;\r\n        if (!settings.url || !settings.key) {\r\n            if (!isSilent) alert('请先在设置中配置AI API');\r\n            return;\r\n        }\r\n\r\n        const btn = document.getElementById('trigger-ai-moment-btn');\r\n        let originalText = '';\r\n        if (btn) {\r\n            originalText = btn.textContent;\r\n            btn.textContent = '生成中...';\r\n            btn.disabled = true;\r\n        }\r\n\r\n        try {\r\n            let systemPrompt = `你现在扮演 ${contact.name}。\r\n人设：${contact.persona || '无'}\r\n请生成一条朋友圈动态内容。\r\n内容要求：\r\n1. 符合你的人设。\r\n2. 像真实的朋友圈，可以是心情、生活分享、吐槽等。\r\n3. 不要太长，通常在100字以内。\r\n4. 直接返回内容文本，不要包含任何解释、引号或前缀后缀。`;\r\n\r\n            let fetchUrl = settings.url;\r\n            if (!fetchUrl.endsWith('/chat/completions')) {\r\n                fetchUrl = fetchUrl.endsWith('/') ? fetchUrl + 'chat/completions' : fetchUrl + '/chat/completions';\r\n            }\r\n\r\n            const response = await fetch(fetchUrl, {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    'Authorization': `Bearer ${settings.key}`\r\n                },\r\n                body: JSON.stringify({\r\n                    model: settings.model,\r\n                    messages: [\r\n                        { role: 'system', content: systemPrompt },\r\n                        { role: 'user', content: '发一条朋友圈' }\r\n                    ],\r\n                    temperature: 0.8\r\n                })\r\n            });\r\n\r\n            if (!response.ok) {\r\n                throw new Error(`API Error: ${response.status}`);\r\n            }\r\n\r\n            const data = await response.json();\r\n            let content = data.choices[0].message.content.trim();\r\n            \r\n            // 去除可能的引号\r\n            if ((content.startsWith('\"') && content.endsWith('\"')) || (content.startsWith('“') && content.endsWith('”'))) {\r\n                content = content.slice(1, -1);\r\n            }\r\n\r\n            addMoment(contact.id, content);\r\n            \r\n            if (!isSilent) {\r\n                alert('动态发布成功！');\r\n                document.getElementById('chat-settings-screen').classList.add('hidden');\r\n            }\r\n\r\n        } catch (error) {\r\n            console.error('AI生成动态失败:', error);\r\n            if (!isSilent) alert('生成失败，请检查配置');\r\n        } finally {\r\n            if (btn) {\r\n                btn.textContent = originalText;\r\n                btn.disabled = false;\r\n            }\r\n        }\r\n    }\r\n\r\n    function openPersonaManage() {\r\n        const list = document.getElementById('persona-list');\r\n        list.innerHTML = '';\r\n\r\n        // 确保 userProfile 存在\r\n        if (!state.userProfile) {\r\n            state.userProfile = {\r\n                name: 'User Name',\r\n                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix',\r\n                bgImage: '',\r\n                desc: '点击此处添加个性签名',\r\n                wxid: 'wxid_123456'\r\n            };\r\n        }\r\n\r\n        state.userPersonas.forEach(p => {\r\n            const item = document.createElement('div');\r\n            item.className = `persona-item`;\r\n            // 使用全局头像，名字使用身份的名字\r\n            item.innerHTML = `\r\n                <img src=\"${state.userProfile.avatar}\" class=\"persona-avatar\">\r\n                <div class=\"persona-info\">\r\n                    <div class=\"persona-name\">${p.name || '未命名身份'}</div>\r\n                </div>\r\n                <button class=\"ios-btn-small\" style=\"margin-left: 10px;\" onclick=\"event.stopPropagation(); window.editPersona('${p.id}')\">设置</button>\r\n            `;\r\n            // item.addEventListener('click', () => switchPersona(p.id));\r\n            list.appendChild(item);\r\n        });\r\n\r\n        document.getElementById('persona-manage-modal').classList.remove('hidden');\r\n    }\r\n\r\n    window.editPersona = function(id) {\r\n        // 关闭管理弹窗，打开编辑弹窗\r\n        document.getElementById('persona-manage-modal').classList.add('hidden');\r\n        openPersonaEdit(parseInt(id));\r\n    }\r\n\r\n    function switchPersona(id) {\r\n        state.currentUserPersonaId = id;\r\n        saveConfig();\r\n        renderMeTab();\r\n        document.getElementById('persona-manage-modal').classList.add('hidden');\r\n    }\r\n\r\n    function openPersonaEdit(id = null) {\r\n        currentEditingPersonaId = id;\r\n        const modal = document.getElementById('persona-edit-modal');\r\n        const title = document.getElementById('persona-modal-title');\r\n        const deleteBtn = document.getElementById('delete-persona-btn');\r\n        \r\n        if (id) {\r\n            const p = state.userPersonas.find(p => p.id === id);\r\n            if (p) {\r\n                title.textContent = '编辑身份信息';\r\n                document.getElementById('persona-name').value = p.name || '';\r\n                document.getElementById('persona-ai-prompt').value = p.aiPrompt || '';\r\n                deleteBtn.style.display = 'block';\r\n            }\r\n        } else {\r\n            title.textContent = '新建身份';\r\n            document.getElementById('persona-name').value = '';\r\n            document.getElementById('persona-ai-prompt').value = '';\r\n            deleteBtn.style.display = 'none';\r\n        }\r\n        \r\n        modal.classList.remove('hidden');\r\n    }\r\n\r\n    function handleSavePersona() {\r\n        const name = document.getElementById('persona-name').value;\r\n        const aiPrompt = document.getElementById('persona-ai-prompt').value;\r\n\r\n        if (currentEditingPersonaId) {\r\n            const p = state.userPersonas.find(p => p.id === currentEditingPersonaId);\r\n            if (p) {\r\n                p.name = name;\r\n                p.title = name; // 保持兼容\r\n                p.aiPrompt = aiPrompt;\r\n            }\r\n        } else {\r\n            const newId = Date.now();\r\n            const newPersona = {\r\n                id: newId,\r\n                title: name || '未命名身份',\r\n                name: name || '未命名身份',\r\n                aiPrompt,\r\n                // 以下字段不再使用，但为了兼容性保留或设为空\r\n                personaId: '',\r\n                desc: '',\r\n                avatar: '',\r\n                bgImage: ''\r\n            };\r\n            state.userPersonas.push(newPersona);\r\n            state.currentUserPersonaId = newId; // 自动切换\r\n        }\r\n        \r\n        saveConfig();\r\n        // renderMeTab(); // 资料卡不再随身份变化，不需要重新渲染\r\n        document.getElementById('persona-edit-modal').classList.add('hidden');\r\n    }\r\n\r\n    function handleDeletePersona() {\r\n        if (!currentEditingPersonaId) return;\r\n        if (confirm('确定要删除此身份吗？')) {\r\n            state.userPersonas = state.userPersonas.filter(p => p.id !== currentEditingPersonaId);\r\n            if (state.currentUserPersonaId === currentEditingPersonaId) {\r\n                state.currentUserPersonaId = state.userPersonas.length > 0 ? state.userPersonas[0].id : null;\r\n            }\r\n            saveConfig();\r\n            renderMeTab();\r\n            document.getElementById('persona-edit-modal').classList.add('hidden');\r\n        }\r\n    }\r\n\r\n    // --- 世界书功能 ---\r\n\r\n    let currentEditingEntryId = null;\r\n\r\n    function renderWorldbookList() {\r\n        const list = document.getElementById('worldbook-list');\r\n        const emptyState = document.getElementById('worldbook-empty');\r\n        if (!list) return;\r\n\r\n        list.innerHTML = '';\r\n\r\n        if (!state.worldbook || state.worldbook.length === 0) {\r\n            if (emptyState) emptyState.style.display = 'flex';\r\n            return;\r\n        }\r\n\r\n        if (emptyState) emptyState.style.display = 'none';\r\n\r\n        state.worldbook.forEach(entry => {\r\n            const item = document.createElement('div');\r\n            item.className = 'wb-entry';\r\n            item.innerHTML = `\r\n                <div class=\"wb-header\">\r\n                    <span class=\"wb-keys\">${entry.keys.join(', ')}</span>\r\n                    <span class=\"wb-status ${entry.enabled ? 'enabled' : 'disabled'}\">${entry.enabled ? '启用' : '禁用'}</span>\r\n                </div>\r\n                <div class=\"wb-content\">${entry.content}</div>\r\n            `;\r\n            item.addEventListener('click', () => openWorldbookEdit(entry.id));\r\n            list.appendChild(item);\r\n        });\r\n    }\r\n\r\n    function openWorldbookEdit(entryId = null) {\r\n        currentEditingEntryId = entryId;\r\n        const modal = document.getElementById('worldbook-edit-modal');\r\n        const title = document.getElementById('worldbook-modal-title');\r\n        const keysInput = document.getElementById('wb-keys');\r\n        const contentInput = document.getElementById('wb-content');\r\n        const enabledInput = document.getElementById('wb-enabled');\r\n        const deleteBtn = document.getElementById('delete-worldbook-btn');\r\n\r\n        if (entryId) {\r\n            const entry = state.worldbook.find(e => e.id === entryId);\r\n            if (entry) {\r\n                title.textContent = '编辑条目';\r\n                keysInput.value = entry.keys.join(', ');\r\n                contentInput.value = entry.content;\r\n                enabledInput.checked = entry.enabled;\r\n                deleteBtn.style.display = 'block';\r\n            }\r\n        } else {\r\n            title.textContent = '新建条目';\r\n            keysInput.value = '';\r\n            contentInput.value = '';\r\n            enabledInput.checked = true;\r\n            deleteBtn.style.display = 'none';\r\n        }\r\n\r\n        modal.classList.remove('hidden');\r\n    }\r\n\r\n    function handleSaveWorldbookEntry() {\r\n        const keysInput = document.getElementById('wb-keys');\r\n        const contentInput = document.getElementById('wb-content');\r\n        const enabledInput = document.getElementById('wb-enabled');\r\n\r\n        const keys = keysInput.value.split(/[,，]/).map(k => k.trim()).filter(k => k);\r\n        const content = contentInput.value.trim();\r\n        const enabled = enabledInput.checked;\r\n\r\n        if (keys.length === 0) {\r\n            alert('请输入至少一个关键字');\r\n            return;\r\n        }\r\n\r\n        if (!content) {\r\n            alert('请输入内容');\r\n            return;\r\n        }\r\n\r\n        if (currentEditingEntryId) {\r\n            // 编辑现有\r\n            const entry = state.worldbook.find(e => e.id === currentEditingEntryId);\r\n            if (entry) {\r\n                entry.keys = keys;\r\n                entry.content = content;\r\n                entry.enabled = enabled;\r\n            }\r\n        } else {\r\n            // 新建\r\n            const newEntry = {\r\n                id: Date.now(),\r\n                keys: keys,\r\n                content: content,\r\n                enabled: enabled\r\n            };\r\n            if (!state.worldbook) state.worldbook = [];\r\n            state.worldbook.push(newEntry);\r\n        }\r\n\r\n        saveConfig();\r\n        renderWorldbookList();\r\n        document.getElementById('worldbook-edit-modal').classList.add('hidden');\r\n    }\r\n\r\n    function handleDeleteWorldbookEntry() {\r\n        if (!currentEditingEntryId) return;\r\n\r\n        if (confirm('确定要删除此条目吗？')) {\r\n            state.worldbook = state.worldbook.filter(e => e.id !== currentEditingEntryId);\r\n            saveConfig();\r\n            renderWorldbookList();\r\n            document.getElementById('worldbook-edit-modal').classList.add('hidden');\r\n        }\r\n    }\r\n\r\n    // --- 微信功能 ---\r\n\r\n    function handleSaveContact() {\r\n        const name = document.getElementById('contact-name').value;\r\n        const remark = document.getElementById('contact-remark').value;\r\n        const persona = document.getElementById('contact-persona').value;\r\n        const style = document.getElementById('contact-style').value;\r\n        const avatarInput = document.getElementById('contact-avatar-upload');\r\n        \r\n        if (!name) {\r\n            alert('请输入姓名');\r\n            return;\r\n        }\r\n\r\n        const contact = {\r\n            id: Date.now(),\r\n            name,\r\n            remark,\r\n            persona,\r\n            style,\r\n            avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + name // 默认头像\r\n        };\r\n\r\n        if (avatarInput.files && avatarInput.files[0]) {\r\n            const reader = new FileReader();\r\n            reader.onload = (e) => {\r\n                contact.avatar = e.target.result;\r\n                saveContactAndClose(contact);\r\n            };\r\n            reader.readAsDataURL(avatarInput.files[0]);\r\n        } else {\r\n            saveContactAndClose(contact);\r\n        }\r\n    }\r\n\r\n    function saveContactAndClose(contact) {\r\n        state.contacts.push(contact);\r\n        saveConfig();\r\n        renderContactList();\r\n        \r\n        // 清空输入\r\n        document.getElementById('contact-name').value = '';\r\n        document.getElementById('contact-remark').value = '';\r\n        document.getElementById('contact-persona').value = '';\r\n        document.getElementById('contact-style').value = '';\r\n        document.getElementById('contact-avatar-upload').value = '';\r\n        \r\n        document.getElementById('add-contact-modal').classList.add('hidden');\r\n        openChat(contact.id);\r\n    }\r\n\r\n    function renderContactList() {\r\n        const list = document.getElementById('contact-list');\r\n        if (!list) return;\r\n        \r\n        list.innerHTML = '';\r\n        \r\n        state.contacts.forEach(contact => {\r\n            const item = document.createElement('div');\r\n            item.className = 'contact-item';\r\n            item.innerHTML = `\r\n                <img src=\"${contact.avatar}\" class=\"contact-avatar\">\r\n                <div class=\"contact-info\">\r\n                    <div class=\"contact-name\">${contact.remark || contact.name}</div>\r\n                </div>\r\n            `;\r\n            item.addEventListener('click', () => openChat(contact.id));\r\n            list.appendChild(item);\r\n        });\r\n    }\r\n\r\n    function openChat(contactId) {\r\n        const contact = state.contacts.find(c => c.id === contactId);\r\n        if (!contact) return;\r\n        \r\n        state.currentChatContactId = contactId;\r\n        document.getElementById('chat-title').textContent = contact.remark || contact.name;\r\n        \r\n        // 应用聊天背景\r\n        const chatScreen = document.getElementById('chat-screen');\r\n        if (contact.chatBg) {\r\n            chatScreen.style.backgroundImage = `url(${contact.chatBg})`;\r\n            chatScreen.style.backgroundSize = 'cover';\r\n            chatScreen.style.backgroundPosition = 'center';\r\n        } else {\r\n            chatScreen.style.backgroundImage = '';\r\n        }\r\n        \r\n        chatScreen.classList.remove('hidden');\r\n        \r\n        renderChatHistory(contactId);\r\n    }\r\n\r\n    function openChatSettings() {\r\n        if (!state.currentChatContactId) return;\r\n        const contact = state.contacts.find(c => c.id === state.currentChatContactId);\r\n        if (!contact) return;\r\n\r\n        document.getElementById('chat-setting-remark').value = contact.remark || '';\r\n        document.getElementById('chat-setting-persona').value = contact.persona || '';\r\n        // 清空文件输入\r\n        document.getElementById('chat-setting-avatar').value = '';\r\n        document.getElementById('chat-setting-my-avatar').value = '';\r\n        document.getElementById('chat-setting-bg').value = '';\r\n\r\n        // 填充用户身份下拉框\r\n        const userPersonaSelect = document.getElementById('chat-setting-user-persona');\r\n        userPersonaSelect.innerHTML = '<option value=\"\">-- 选择身份 --</option>';\r\n        state.userPersonas.forEach(p => {\r\n            const option = document.createElement('option');\r\n            option.value = p.id;\r\n            option.textContent = p.name || '未命名身份';\r\n            userPersonaSelect.appendChild(option);\r\n        });\r\n        \r\n        // 选中当前设置的身份\r\n        if (contact.userPersonaId) {\r\n            userPersonaSelect.value = contact.userPersonaId;\r\n        }\r\n\r\n        document.getElementById('chat-settings-screen').classList.remove('hidden');\r\n    }\r\n\r\n    function handleClearChatHistory() {\r\n        if (!state.currentChatContactId) return;\r\n        \r\n        if (confirm('确定要清空与该联系人的所有聊天记录吗？此操作不可恢复。')) {\r\n            state.chatHistory[state.currentChatContactId] = [];\r\n            saveConfig();\r\n            renderChatHistory(state.currentChatContactId);\r\n            alert('聊天记录已清空');\r\n            document.getElementById('chat-settings-screen').classList.add('hidden');\r\n        }\r\n    }\r\n\r\n    function handleSaveChatSettings() {\r\n        if (!state.currentChatContactId) return;\r\n        const contact = state.contacts.find(c => c.id === state.currentChatContactId);\r\n        if (!contact) return;\r\n\r\n        const remark = document.getElementById('chat-setting-remark').value;\r\n        const persona = document.getElementById('chat-setting-persona').value;\r\n        const userPersonaId = document.getElementById('chat-setting-user-persona').value;\r\n        const avatarInput = document.getElementById('chat-setting-avatar');\r\n        const myAvatarInput = document.getElementById('chat-setting-my-avatar');\r\n        const bgInput = document.getElementById('chat-setting-bg');\r\n\r\n        contact.remark = remark;\r\n        contact.persona = persona;\r\n        contact.userPersonaId = userPersonaId ? parseInt(userPersonaId) : null;\r\n        document.getElementById('chat-title').textContent = remark || contact.name;\r\n\r\n        const promises = [];\r\n\r\n        if (avatarInput.files && avatarInput.files[0]) {\r\n            promises.push(new Promise(resolve => {\r\n                const reader = new FileReader();\r\n                reader.onload = (e) => {\r\n                    contact.avatar = e.target.result;\r\n                    resolve();\r\n                };\r\n                reader.readAsDataURL(avatarInput.files[0]);\r\n            }));\r\n        }\r\n\r\n        if (myAvatarInput.files && myAvatarInput.files[0]) {\r\n            promises.push(new Promise(resolve => {\r\n                const reader = new FileReader();\r\n                reader.onload = (e) => {\r\n                    contact.myAvatar = e.target.result;\r\n                    resolve();\r\n                };\r\n                reader.readAsDataURL(myAvatarInput.files[0]);\r\n            }));\r\n        }\r\n\r\n        if (bgInput.files && bgInput.files[0]) {\r\n            promises.push(new Promise(resolve => {\r\n                const reader = new FileReader();\r\n                reader.onload = (e) => {\r\n                    contact.chatBg = e.target.result;\r\n                    resolve();\r\n                };\r\n                reader.readAsDataURL(bgInput.files[0]);\r\n            }));\r\n        }\r\n\r\n        Promise.all(promises).then(() => {\r\n            saveConfig();\r\n            renderContactList(); // 更新列表头像/备注\r\n            renderChatHistory(contact.id); // 更新聊天记录头像\r\n            \r\n            // 更新背景\r\n            const chatScreen = document.getElementById('chat-screen');\r\n            if (contact.chatBg) {\r\n                chatScreen.style.backgroundImage = `url(${contact.chatBg})`;\r\n                chatScreen.style.backgroundSize = 'cover';\r\n                chatScreen.style.backgroundPosition = 'center';\r\n            } else {\r\n                chatScreen.style.backgroundImage = '';\r\n            }\r\n\r\n            document.getElementById('chat-settings-screen').classList.add('hidden');\r\n        });\r\n    }\r\n\r\n    function renderChatHistory(contactId) {\r\n        const messages = state.chatHistory[contactId] || [];\r\n        const container = document.getElementById('chat-messages');\r\n        container.innerHTML = '';\r\n        \r\n        messages.forEach(msg => {\r\n            appendMessageToUI(msg.content, msg.role === 'user');\r\n        });\r\n        \r\n        scrollToBottom();\r\n    }\r\n\r\n    function sendMessage(text, isUser) {\r\n        if (!state.currentChatContactId) return;\r\n        \r\n        // 保存消息\r\n        if (!state.chatHistory[state.currentChatContactId]) {\r\n            state.chatHistory[state.currentChatContactId] = [];\r\n        }\r\n        \r\n        state.chatHistory[state.currentChatContactId].push({\r\n            role: isUser ? 'user' : 'assistant',\r\n            content: text\r\n        });\r\n        \r\n        saveConfig(); // 简单起见，每次发送都保存\r\n        \r\n        appendMessageToUI(text, isUser);\r\n        scrollToBottom();\r\n    }\r\n\r\n    function appendMessageToUI(text, isUser) {\r\n        // 隐藏自动同步的评论消息和动态发布消息，但保留在历史记录中供AI读取\r\n        if (text && typeof text === 'string') {\r\n            if (text.startsWith('[评论了你的动态: \"') || text.startsWith('[发布了动态]:')) {\r\n                return;\r\n            }\r\n        }\r\n\r\n        const container = document.getElementById('chat-messages');\r\n        const msgDiv = document.createElement('div');\r\n        msgDiv.className = `chat-message ${isUser ? 'user' : 'other'}`;\r\n        \r\n        const contact = state.contacts.find(c => c.id === state.currentChatContactId);\r\n        \r\n        if (!isUser) {\r\n            const avatar = contact ? contact.avatar : '';\r\n            msgDiv.innerHTML = `\r\n                <img src=\"${avatar}\" class=\"chat-avatar\">\r\n                <div class=\"message-content\">${text}</div>\r\n            `;\r\n        } else {\r\n            let myAvatar = 'https://api.dicebear.com/7.x/avataaars/svg?seed=User';\r\n            \r\n            // 优先使用聊天特定的设置\r\n            if (contact && contact.myAvatar) {\r\n                myAvatar = contact.myAvatar;\r\n            } else if (state.currentUserPersonaId) {\r\n                // 使用全局人设\r\n                const p = state.userPersonas.find(p => p.id === state.currentUserPersonaId);\r\n                if (p) myAvatar = p.avatar;\r\n            }\r\n\r\n            msgDiv.innerHTML = `\r\n                <img src=\"${myAvatar}\" class=\"chat-avatar\">\r\n                <div class=\"message-content\">${text}</div>\r\n            `;\r\n        }\r\n        \r\n        container.appendChild(msgDiv);\r\n    }\r\n\r\n    function scrollToBottom() {\r\n        const container = document.getElementById('chat-messages');\r\n        container.scrollTop = container.scrollHeight;\r\n    }\r\n\r\n    async function generateAiReply() {\r\n        if (!state.currentChatContactId) return;\r\n        \r\n        const contact = state.contacts.find(c => c.id === state.currentChatContactId);\r\n        if (!contact) return;\r\n\r\n        const settings = state.aiSettings.url ? state.aiSettings : state.aiSettings2;\r\n        if (!settings.url || !settings.key) {\r\n            alert('请先在设置中配置AI API');\r\n            return;\r\n        }\r\n\r\n        const history = state.chatHistory[state.currentChatContactId] || [];\r\n        \r\n        // 获取当前用户人设信息\r\n        let userPromptInfo = '';\r\n        let currentPersona = null;\r\n\r\n        // 优先使用聊天设置中指定的身份\r\n        if (contact.userPersonaId) {\r\n            currentPersona = state.userPersonas.find(p => p.id === contact.userPersonaId);\r\n        }\r\n\r\n        // 如果没有指定，或者找不到，则不发送特定人设信息，或者可以回退到全局资料卡名字\r\n        if (currentPersona) {\r\n            userPromptInfo = `\\n用户(我)的网名：${currentPersona.name || '未命名'}`;\r\n            if (currentPersona.aiPrompt) {\r\n                userPromptInfo += `\\n用户(我)的人设：${currentPersona.aiPrompt}`;\r\n            }\r\n        } else if (state.userProfile) {\r\n             // 回退到全局资料卡名字，但不发送人设 Prompt\r\n            userPromptInfo = `\\n用户(我)的网名：${state.userProfile.name}`;\r\n        }\r\n\r\n        // 获取最近的朋友圈互动上下文\r\n        let momentContext = '';\r\n        const contactMoments = state.moments.filter(m => m.contactId === contact.id);\r\n        if (contactMoments.length > 0) {\r\n            // 按时间倒序，取最新的\r\n            const lastMoment = contactMoments.sort((a, b) => b.time - a.time)[0];\r\n            momentContext += `\\n【朋友圈状态】\\n你最新的一条朋友圈是：“${lastMoment.content}”\\n`;\r\n            \r\n            if (lastMoment.comments && lastMoment.comments.length > 0) {\r\n                // 查找用户的最新评论\r\n                const userName = currentPersona ? currentPersona.name : state.userProfile.name;\r\n                const userComments = lastMoment.comments.filter(c => c.user === userName);\r\n                if (userComments.length > 0) {\r\n                    const lastComment = userComments[userComments.length - 1];\r\n                    momentContext += `用户刚刚评论了你的朋友圈：“${lastComment.content}”\\n`;\r\n                }\r\n            }\r\n        }\r\n\r\n        // 构建 Prompt\r\n        let systemPrompt = `你现在扮演 ${contact.name}。\r\n人设：${contact.persona || '无'}\r\n聊天风格：${contact.style || '正常'}\r\n${userPromptInfo}\r\n${momentContext}\r\n\r\n你拥有一个“微信朋友圈”功能。\r\n1. 当用户发送的消息格式为 '[评论了你的动态: \"...\"] ...' 时，表示用户在朋友圈评论了你的动态。请结合动态内容和用户的评论进行回复。\r\n2. 当用户发送的消息格式为 '[发布了动态]: ...' 时，表示用户刚刚发了一条朋友圈。你可以根据人设决定是否去点赞或评论。\r\n\r\n【指令说明】\r\n- 如果你想发朋友圈，请在回复最后另起一行输出：MOMENT: 内容\r\n- 如果你想给用户最新的动态点赞，请在回复最后另起一行输出：ACTION: LIKE_MOMENT\r\n- 如果你想评论用户最新的动态，请在回复最后另起一行输出：ACTION: COMMENT_MOMENT: 评论内容\r\n\r\n注意：\r\n1. 指令必须在回复的最后，不要放在中间。\r\n2. 正常回复应该自然，不要机械地说“我点赞了”。\r\n3. 如果不想执行操作，就不要输出指令。\r\n\r\n请回复对方的消息。保持简短，像微信聊天一样。\r\n请生成 1 到 3 条回复，每条回复之间用 '|||' 分隔。不要包含其他解释性文字。`;\r\n\r\n        // 添加世界书内容\r\n        if (state.worldbook && state.worldbook.length > 0) {\r\n            const activeEntries = state.worldbook.filter(e => e.enabled);\r\n            if (activeEntries.length > 0) {\r\n                systemPrompt += '\\n\\n世界书信息：\\n';\r\n                activeEntries.forEach(entry => {\r\n                    // 简单匹配：如果历史记录中包含关键字，则添加内容\r\n                    // 这里为了简化，直接添加所有启用的条目，或者可以做更复杂的匹配逻辑\r\n                    // 考虑到上下文长度，这里简单添加所有启用的\r\n                    systemPrompt += `${entry.content}\\n`;\r\n                });\r\n            }\r\n        }\r\n\r\n        const messages = [\r\n            { role: 'system', content: systemPrompt },\r\n            ...history.map(h => ({ role: h.role, content: h.content }))\r\n        ];\r\n\r\n        // UI 显示正在输入...\r\n        const titleEl = document.getElementById('chat-title');\r\n        const originalTitle = titleEl.textContent;\r\n        titleEl.textContent = '正在输入中...';\r\n\r\n        try {\r\n            let fetchUrl = settings.url;\r\n            if (!fetchUrl.endsWith('/chat/completions')) {\r\n                fetchUrl = fetchUrl.endsWith('/') ? fetchUrl + 'chat/completions' : fetchUrl + '/chat/completions';\r\n            }\r\n\r\n            const response = await fetch(fetchUrl, {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    'Authorization': `Bearer ${settings.key}`\r\n                },\r\n                body: JSON.stringify({\r\n                    model: settings.model,\r\n                    messages: messages,\r\n                    temperature: settings.temperature\r\n                })\r\n            });\r\n\r\n            if (!response.ok) {\r\n                throw new Error(`API Error: ${response.status}`);\r\n            }\r\n\r\n            const data = await response.json();\r\n            let replyContent = data.choices[0].message.content;\r\n\r\n            // 解析朋友圈指令\r\n            const momentRegex = /(?:^|\\n)MOMENT:\\s*([\\s\\S]*?)$/;\r\n            const momentMatch = replyContent.match(momentRegex);\r\n            \r\n            if (momentMatch) {\r\n                const momentContent = momentMatch[1].trim();\r\n                if (momentContent) {\r\n                    addMoment(contact.id, momentContent);\r\n                }\r\n                replyContent = replyContent.replace(momentMatch[0], '').trim();\r\n            }\r\n\r\n            // 解析点赞指令\r\n            const likeRegex = /(?:^|\\n)ACTION:\\s*LIKE_MOMENT\\s*$/;\r\n            const likeMatch = replyContent.match(likeRegex);\r\n            if (likeMatch) {\r\n                // 查找用户最新的一条动态\r\n                const userMoments = state.moments.filter(m => m.contactId === 'me');\r\n                if (userMoments.length > 0) {\r\n                    const latestMoment = userMoments.sort((a, b) => b.time - a.time)[0];\r\n                    // 检查是否已经点赞\r\n                    const aiName = contact.remark || contact.name;\r\n                    if (!latestMoment.likes || !latestMoment.likes.includes(aiName)) {\r\n                        toggleLike(latestMoment.id, aiName);\r\n                    }\r\n                }\r\n                replyContent = replyContent.replace(likeMatch[0], '').trim();\r\n            }\r\n\r\n            // 解析评论指令\r\n            const commentRegex = /(?:^|\\n)ACTION:\\s*COMMENT_MOMENT:\\s*([\\s\\S]*?)$/;\r\n            const commentMatch = replyContent.match(commentRegex);\r\n            if (commentMatch) {\r\n                const commentContent = commentMatch[1].trim();\r\n                // 查找用户最新的一条动态\r\n                const userMoments = state.moments.filter(m => m.contactId === 'me');\r\n                if (userMoments.length > 0 && commentContent) {\r\n                    const latestMoment = userMoments.sort((a, b) => b.time - a.time)[0];\r\n                    const aiName = contact.remark || contact.name;\r\n                    submitComment(latestMoment.id, commentContent, null, aiName);\r\n                }\r\n                replyContent = replyContent.replace(commentMatch[0], '').trim();\r\n            }\r\n\r\n            // 解析多条回复\r\n            const replies = replyContent.split('|||').map(r => r.trim()).filter(r => r);\r\n\r\n            for (const reply of replies) {\r\n                await typewriterEffect(reply, contact.avatar);\r\n                // 简单的延迟，让多条消息之间有间隔\r\n                await new Promise(r => setTimeout(r, 500));\r\n            }\r\n\r\n        } catch (error) {\r\n            console.error('AI生成失败:', error);\r\n            alert('AI生成失败，请检查配置');\r\n        } finally {\r\n            // 恢复标题\r\n            const currentContact = state.contacts.find(c => c.id === state.currentChatContactId);\r\n            if (currentContact) {\r\n                titleEl.textContent = currentContact.remark || currentContact.name;\r\n            } else {\r\n                titleEl.textContent = originalTitle;\r\n            }\r\n        }\r\n    }\r\n\r\n    function typewriterEffect(text, avatarUrl) {\r\n        return new Promise(resolve => {\r\n            const container = document.getElementById('chat-messages');\r\n            const msgDiv = document.createElement('div');\r\n            msgDiv.className = 'chat-message other';\r\n            msgDiv.innerHTML = `\r\n                <img src=\"${avatarUrl}\" class=\"chat-avatar\">\r\n                <div class=\"message-content\">${text}</div>\r\n            `;\r\n            container.appendChild(msgDiv);\r\n            \r\n            // 保存完整的消息到历史记录\r\n            if (!state.chatHistory[state.currentChatContactId]) {\r\n                state.chatHistory[state.currentChatContactId] = [];\r\n            }\r\n            state.chatHistory[state.currentChatContactId].push({\r\n                role: 'assistant',\r\n                content: text\r\n            });\r\n            saveConfig();\r\n            \r\n            scrollToBottom();\r\n            resolve();\r\n        });\r\n    }\r\n\r\n    // --- 字体功能 ---\r\n\r\n    function handleFontUpload(e) {\r\n        const file = e.target.files[0];\r\n        if (!file) return;\r\n\r\n        const reader = new FileReader();\r\n        reader.onload = (event) => {\r\n            const fontName = `CustomFont_${Date.now()}`;\r\n            const fontFace = new FontFace(fontName, `url(${event.target.result})`);\r\n            \r\n            fontFace.load().then((loadedFace) => {\r\n                document.fonts.add(loadedFace);\r\n                addFontToState(fontName, event.target.result, 'local');\r\n            }).catch(err => {\r\n                console.error('字体加载失败:', err);\r\n                alert('字体加载失败，请检查文件格式');\r\n            });\r\n        };\r\n        reader.readAsDataURL(file);\r\n    }\r\n\r\n    function handleFontUrl() {\r\n        const url = document.getElementById('font-url').value.trim();\r\n        if (!url) return;\r\n\r\n        const fontName = `WebFont_${Date.now()}`;\r\n        const style = document.createElement('style');\r\n        style.textContent = `@font-face { font-family: '${fontName}'; src: url('${url}'); }`;\r\n        document.head.appendChild(style);\r\n        \r\n        addFontToState(fontName, url, 'url');\r\n        document.getElementById('font-url').value = '';\r\n    }\r\n\r\n    function addFontToState(name, source, type) {\r\n        state.fonts.push({ name, source, type });\r\n        state.currentFont = name;\r\n        applyFont(name);\r\n        saveConfig();\r\n    }\r\n\r\n    function applyFont(fontName) {\r\n        if (fontName === 'default') {\r\n            document.documentElement.style.setProperty('--font-family', '-apple-system, BlinkMacSystemFont, \"San Francisco\", \"Helvetica Neue\", Helvetica, Arial, sans-serif');\r\n        } else {\r\n            const font = state.fonts.find(f => f.name === fontName);\r\n            if (font) {\r\n                if (font.type === 'local') {\r\n                    const fontFace = new FontFace(font.name, `url(${font.source})`);\r\n                    fontFace.load().then(loadedFace => {\r\n                        document.fonts.add(loadedFace);\r\n                        document.documentElement.style.setProperty('--font-family', fontName);\r\n                    }).catch(() => {\r\n                        document.documentElement.style.setProperty('--font-family', fontName);\r\n                    });\r\n                } else {\r\n                    if (!document.getElementById(`style-${font.name}`)) {\r\n                        const style = document.createElement('style');\r\n                        style.id = `style-${font.name}`;\r\n                        style.textContent = `@font-face { font-family: '${font.name}'; src: url('${font.source}'); }`;\r\n                        document.head.appendChild(style);\r\n                    }\r\n                    document.documentElement.style.setProperty('--font-family', fontName);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    function handleDeleteFont() {\r\n        if (state.currentFont === 'default') return;\r\n        state.fonts = state.fonts.filter(f => f.name !== state.currentFont);\r\n        state.currentFont = 'default';\r\n        applyFont('default');\r\n        saveConfig();\r\n    }\r\n\r\n    // --- 字体预设功能 ---\r\n\r\n    function handleSaveFontPreset() {\r\n        const name = prompt('请输入字体预设名称：');\r\n        if (!name) return;\r\n        \r\n        const preset = {\r\n            name: name,\r\n            font: state.currentFont\r\n        };\r\n        \r\n        state.fontPresets.push(preset);\r\n        saveConfig();\r\n        renderFontPresets();\r\n        document.getElementById('font-preset-select').value = name;\r\n        alert('字体预设已保存');\r\n    }\r\n\r\n    function handleDeleteFontPreset() {\r\n        const select = document.getElementById('font-preset-select');\r\n        const name = select.value;\r\n        if (!name) return;\r\n        \r\n        if (confirm(`确定要删除预设 \"${name}\" 吗？`)) {\r\n            state.fontPresets = state.fontPresets.filter(p => p.name !== name);\r\n            saveConfig();\r\n            renderFontPresets();\r\n        }\r\n    }\r\n\r\n    function handleApplyFontPreset(e) {\r\n        const name = e.target.value;\r\n        if (!name) return;\r\n        \r\n        const preset = state.fontPresets.find(p => p.name === name);\r\n        if (preset) {\r\n            state.currentFont = preset.font;\r\n            applyFont(state.currentFont);\r\n            saveConfig();\r\n        }\r\n    }\r\n\r\n    function renderFontPresets() {\r\n        const select = document.getElementById('font-preset-select');\r\n        if (!select) return;\r\n        \r\n        const currentValue = select.value;\r\n        select.innerHTML = '<option value=\"\">-- 选择预设 --</option>';\r\n        \r\n        if (state.fontPresets) {\r\n            state.fontPresets.forEach(preset => {\r\n                const option = document.createElement('option');\r\n                option.value = preset.name;\r\n                option.textContent = preset.name;\r\n                select.appendChild(option);\r\n            });\r\n        }\r\n        \r\n        // 尝试恢复选中状态\r\n        if (currentValue && state.fontPresets.some(p => p.name === currentValue)) {\r\n            select.value = currentValue;\r\n        }\r\n    }\r\n\r\n    // --- 壁纸功能 ---\r\n\r\n    function handleWallpaperUpload(e) {\r\n        const file = e.target.files[0];\r\n        if (!file) return;\r\n\r\n        const reader = new FileReader();\r\n        reader.onload = (event) => {\r\n            const wallpaper = {\r\n                id: Date.now(),\r\n                data: event.target.result\r\n            };\r\n            state.wallpapers.push(wallpaper);\r\n            state.currentWallpaper = wallpaper.id;\r\n            applyWallpaper(wallpaper.id);\r\n            renderWallpaperGallery();\r\n            saveConfig();\r\n        };\r\n        reader.readAsDataURL(file);\r\n    }\r\n\r\n    function renderWallpaperGallery() {\r\n        const gallery = document.getElementById('wallpaper-gallery');\r\n        if (!gallery) return;\r\n        \r\n        gallery.innerHTML = '';\r\n        \r\n        state.wallpapers.forEach(wp => {\r\n            const item = document.createElement('div');\r\n            item.className = `gallery-item ${state.currentWallpaper === wp.id ? 'selected' : ''}`;\r\n            item.innerHTML = `\r\n                <img src=\"${wp.data}\" alt=\"Wallpaper\">\r\n                <button class=\"delete-wp-btn\" data-id=\"${wp.id}\">&times;</button>\r\n            `;\r\n            \r\n            item.addEventListener('click', (e) => {\r\n                if (e.target.classList.contains('delete-wp-btn')) {\r\n                    deleteWallpaper(wp.id);\r\n                } else {\r\n                    state.currentWallpaper = wp.id;\r\n                    applyWallpaper(wp.id);\r\n                    renderWallpaperGallery();\r\n                    saveConfig();\r\n                }\r\n            });\r\n            \r\n            gallery.appendChild(item);\r\n        });\r\n    }\r\n\r\n    function deleteWallpaper(id) {\r\n        state.wallpapers = state.wallpapers.filter(wp => wp.id !== id);\r\n        if (state.currentWallpaper === id) {\r\n            state.currentWallpaper = null;\r\n            applyWallpaper(null);\r\n        }\r\n        renderWallpaperGallery();\r\n        saveConfig();\r\n    }\r\n\r\n    function applyWallpaper(id) {\r\n        if (!id) {\r\n            document.documentElement.style.setProperty('--wallpaper', 'none');\r\n            return;\r\n        }\r\n        const wp = state.wallpapers.find(w => w.id === id);\r\n        if (wp) {\r\n            document.documentElement.style.setProperty('--wallpaper', `url(${wp.data})`);\r\n        }\r\n    }\r\n\r\n    // --- 图标功能 ---\r\n\r\n    function renderIconSettings() {\r\n        const list = document.getElementById('icon-setting-list');\r\n        if (!list) return;\r\n        \r\n        list.innerHTML = '';\r\n\r\n        appList.forEach(app => {\r\n            const item = document.createElement('div');\r\n            item.className = 'list-item';\r\n            \r\n            const currentIcon = state.icons[app.id];\r\n            let previewContent = '';\r\n            \r\n            // 安全地获取预览内容\r\n            if (currentIcon) {\r\n                previewContent = `<img src=\"${currentIcon}\">`;\r\n            } else {\r\n                const el = document.querySelector(app.selector + ' i');\r\n                if (el) {\r\n                    previewContent = `<i class=\"${el.className}\"></i>`;\r\n                } else {\r\n                    // 如果找不到i标签（可能已经被替换为img但state中没有记录），尝试恢复默认\r\n                    previewContent = '<i class=\"fas fa-question\"></i>';\r\n                }\r\n            }\r\n\r\n            item.innerHTML = `\r\n                <div class=\"icon-row\">\r\n                    <div class=\"icon-preview-small\" id=\"preview-${app.id}\">\r\n                        ${previewContent}\r\n                    </div>\r\n                    <div class=\"icon-info\">${app.name}</div>\r\n                    <div class=\"icon-actions\">\r\n                        <input type=\"file\" id=\"upload-${app.id}\" accept=\"image/*\" class=\"file-input-hidden\">\r\n                        <label for=\"upload-${app.id}\" class=\"ios-btn\">更换</label>\r\n                        ${currentIcon ? `<button class=\"ios-btn-small danger\" onclick=\"resetAppIcon('${app.id}')\">还原</button>` : ''}\r\n                    </div>\r\n                </div>\r\n            `;\r\n\r\n            // 绑定上传事件\r\n            const input = item.querySelector('input');\r\n            input.addEventListener('change', (e) => handleIconUpload(e, app.id));\r\n            \r\n            // 绑定还原事件\r\n            const resetBtn = item.querySelector('button');\r\n            if (resetBtn) {\r\n                resetBtn.addEventListener('click', () => resetAppIcon(app.id));\r\n            }\r\n\r\n            list.appendChild(item);\r\n        });\r\n    }\r\n\r\n    function handleIconUpload(e, appId) {\r\n        const file = e.target.files[0];\r\n        if (!file) return;\r\n\r\n        const reader = new FileReader();\r\n        reader.onload = (event) => {\r\n            state.icons[appId] = event.target.result;\r\n            applyIcons();\r\n            renderIconSettings();\r\n            saveConfig();\r\n        };\r\n        reader.readAsDataURL(file);\r\n    }\r\n\r\n    window.resetAppIcon = function(appId) {\r\n        delete state.icons[appId];\r\n        applyIcons();\r\n        renderIconSettings();\r\n        saveConfig();\r\n    };\r\n\r\n    function applyIcons() {\r\n        appList.forEach(app => {\r\n            const el = document.querySelector(app.selector);\r\n            if (!el) return;\r\n            \r\n            const iconData = state.icons[app.id];\r\n            \r\n            if (iconData) {\r\n                el.innerHTML = `<img src=\"${iconData}\" style=\"width:100%;height:100%;object-fit:cover;border-radius:var(--icon-radius);\">`;\r\n                el.style.background = 'transparent';\r\n            } else {\r\n                const originalIcons = {\r\n                    'icon-envelope': 'fas fa-envelope',\r\n                    'icon-wechat': 'fab fa-weixin',\r\n                    'icon-world': 'fas fa-globe',\r\n                    'icon-settings': 'fas fa-cog',\r\n                    'icon-theme': 'fas fa-paint-brush',\r\n                    'icon-shopping': 'fas fa-shopping-bag',\r\n                    'icon-forum': 'fas fa-comments',\r\n                    'icon-phone': 'fas fa-mobile-alt'\r\n                };\r\n                el.innerHTML = `<i class=\"${originalIcons[app.id]}\"></i>`;\r\n                el.style.background = '';\r\n            }\r\n        });\r\n    }\r\n\r\n    // --- CSS功能 ---\r\n\r\n    function applyCSS(cssContent) {\r\n        let styleEl = document.getElementById('custom-user-css');\r\n        if (!styleEl) {\r\n            styleEl = document.createElement('style');\r\n            styleEl.id = 'custom-user-css';\r\n            document.head.appendChild(styleEl);\r\n        }\r\n        styleEl.textContent = cssContent;\r\n    }\r\n\r\n    function exportCSS() {\r\n        const blob = new Blob([state.css], { type: 'text/css' });\r\n        const url = URL.createObjectURL(blob);\r\n        const a = document.createElement('a');\r\n        a.href = url;\r\n        a.download = 'custom-theme.css';\r\n        a.click();\r\n        URL.revokeObjectURL(url);\r\n    }\r\n\r\n    // --- CSS预设功能 ---\r\n\r\n    function handleSaveCssPreset() {\r\n        const name = prompt('请输入CSS预设名称：');\r\n        if (!name) return;\r\n        \r\n        const cssContent = document.getElementById('css-editor').value;\r\n        \r\n        const preset = {\r\n            name: name,\r\n            css: cssContent\r\n        };\r\n        \r\n        state.cssPresets.push(preset);\r\n        saveConfig();\r\n        renderCssPresets();\r\n        document.getElementById('css-preset-select').value = name;\r\n        alert('CSS预设已保存');\r\n    }\r\n\r\n    function handleDeleteCssPreset() {\r\n        const select = document.getElementById('css-preset-select');\r\n        const name = select.value;\r\n        if (!name) return;\r\n        \r\n        if (confirm(`确定要删除预设 \"${name}\" 吗？`)) {\r\n            state.cssPresets = state.cssPresets.filter(p => p.name !== name);\r\n            saveConfig();\r\n            renderCssPresets();\r\n        }\r\n    }\r\n\r\n    function handleApplyCssPreset(e) {\r\n        const name = e.target.value;\r\n        if (!name) return;\r\n        \r\n        const preset = state.cssPresets.find(p => p.name === name);\r\n        if (preset) {\r\n            state.css = preset.css;\r\n            document.getElementById('css-editor').value = state.css;\r\n            applyCSS(state.css);\r\n            saveConfig();\r\n        }\r\n    }\r\n\r\n    function renderCssPresets() {\r\n        const select = document.getElementById('css-preset-select');\r\n        if (!select) return;\r\n        \r\n        const currentValue = select.value;\r\n        select.innerHTML = '<option value=\"\">-- 选择预设 --</option>';\r\n        \r\n        if (state.cssPresets) {\r\n            state.cssPresets.forEach(preset => {\r\n                const option = document.createElement('option');\r\n                option.value = preset.name;\r\n                option.textContent = preset.name;\r\n                select.appendChild(option);\r\n            });\r\n        }\r\n        \r\n        if (currentValue && state.cssPresets.some(p => p.name === currentValue)) {\r\n            select.value = currentValue;\r\n        }\r\n    }\r\n\r\n    // --- AI 设置功能 ---\r\n\r\n    async function handleFetchModels(isSecondary = false) {\r\n        const suffix = isSecondary ? '-2' : '';\r\n        const settingsKey = isSecondary ? 'aiSettings2' : 'aiSettings';\r\n        \r\n        const url = state[settingsKey].url;\r\n        const key = state[settingsKey].key;\r\n\r\n        if (!url) {\r\n            alert('请先输入API地址');\r\n            return;\r\n        }\r\n\r\n        const btn = document.getElementById(`fetch-models${suffix}`);\r\n        const originalText = btn.textContent;\r\n        btn.textContent = '拉取中...';\r\n        btn.disabled = true;\r\n\r\n        try {\r\n            // 尝试适配不同的API格式，通常是 /v1/models\r\n            let fetchUrl = url;\r\n            if (!fetchUrl.endsWith('/models')) {\r\n                fetchUrl = fetchUrl.endsWith('/') ? fetchUrl + 'models' : fetchUrl + '/models';\r\n            }\r\n\r\n            const headers = {};\r\n            if (key) {\r\n                headers['Authorization'] = `Bearer ${key}`;\r\n            }\r\n\r\n            const response = await fetch(fetchUrl, { headers });\r\n            if (!response.ok) {\r\n                throw new Error(`HTTP error! status: ${response.status}`);\r\n            }\r\n\r\n            const data = await response.json();\r\n            const models = data.data || data.models || []; // 适配不同API返回格式\r\n\r\n            const select = document.getElementById(`ai-model-select${suffix}`);\r\n            select.innerHTML = '<option value=\"\">请选择模型</option>';\r\n            \r\n            models.forEach(model => {\r\n                const id = model.id || model;\r\n                const option = document.createElement('option');\r\n                option.value = id;\r\n                option.textContent = id;\r\n                select.appendChild(option);\r\n            });\r\n\r\n            alert(`成功获取 ${models.length} 个模型`);\r\n            \r\n            // 如果当前有选中的模型，尝试恢复\r\n            if (state[settingsKey].model) {\r\n                select.value = state[settingsKey].model;\r\n            }\r\n\r\n        } catch (error) {\r\n            console.error('获取模型失败:', error);\r\n            alert('获取模型失败，请检查API地址和密钥是否正确，或跨域设置。');\r\n        } finally {\r\n            btn.textContent = originalText;\r\n            btn.disabled = false;\r\n        }\r\n    }\r\n\r\n    function handleSaveAiPreset(isSecondary = false) {\r\n        const suffix = isSecondary ? '-2' : '';\r\n        const settingsKey = isSecondary ? 'aiSettings2' : 'aiSettings';\r\n        const presetsKey = isSecondary ? 'aiPresets2' : 'aiPresets';\r\n        \r\n        const name = prompt('请输入AI配置预设名称：');\r\n        if (!name) return;\r\n\r\n        const preset = {\r\n            name: name,\r\n            settings: { ...state[settingsKey] }\r\n        };\r\n\r\n        state[presetsKey].push(preset);\r\n        saveConfig();\r\n        renderAiPresets(isSecondary);\r\n        document.getElementById(`ai-preset-select${suffix}`).value = name;\r\n        alert('AI预设已保存');\r\n    }\r\n\r\n    function handleDeleteAiPreset(isSecondary = false) {\r\n        const suffix = isSecondary ? '-2' : '';\r\n        const presetsKey = isSecondary ? 'aiPresets2' : 'aiPresets';\r\n        \r\n        const select = document.getElementById(`ai-preset-select${suffix}`);\r\n        const name = select.value;\r\n        if (!name) return;\r\n\r\n        if (confirm(`确定要删除预设 \"${name}\" 吗？`)) {\r\n            state[presetsKey] = state[presetsKey].filter(p => p.name !== name);\r\n            saveConfig();\r\n            renderAiPresets(isSecondary);\r\n        }\r\n    }\r\n\r\n    function handleApplyAiPreset(e, isSecondary = false) {\r\n        const settingsKey = isSecondary ? 'aiSettings2' : 'aiSettings';\r\n        const presetsKey = isSecondary ? 'aiPresets2' : 'aiPresets';\r\n        \r\n        const name = e.target.value;\r\n        if (!name) return;\r\n\r\n        const preset = state[presetsKey].find(p => p.name === name);\r\n        if (preset) {\r\n            state[settingsKey] = { ...preset.settings };\r\n            updateAiUi(isSecondary);\r\n            saveConfig();\r\n        }\r\n    }\r\n\r\n    function renderAiPresets(isSecondary = false) {\r\n        const suffix = isSecondary ? '-2' : '';\r\n        const presetsKey = isSecondary ? 'aiPresets2' : 'aiPresets';\r\n        \r\n        const select = document.getElementById(`ai-preset-select${suffix}`);\r\n        if (!select) return;\r\n\r\n        const currentValue = select.value;\r\n        select.innerHTML = '<option value=\"\">-- 选择预设 --</option>';\r\n\r\n        if (state[presetsKey]) {\r\n            state[presetsKey].forEach(preset => {\r\n                const option = document.createElement('option');\r\n                option.value = preset.name;\r\n                option.textContent = preset.name;\r\n                select.appendChild(option);\r\n            });\r\n        }\r\n\r\n        if (currentValue && state[presetsKey].some(p => p.name === currentValue)) {\r\n            select.value = currentValue;\r\n        }\r\n    }\r\n\r\n    function updateAiUi(isSecondary = false) {\r\n        const suffix = isSecondary ? '-2' : '';\r\n        const settingsKey = isSecondary ? 'aiSettings2' : 'aiSettings';\r\n        \r\n        const urlInput = document.getElementById(`ai-api-url${suffix}`);\r\n        const keyInput = document.getElementById(`ai-api-key${suffix}`);\r\n        const modelSelect = document.getElementById(`ai-model-select${suffix}`);\r\n        const tempInput = document.getElementById(`ai-temperature${suffix}`);\r\n        const tempValue = document.getElementById(`ai-temp-value${suffix}`);\r\n\r\n        if (urlInput) urlInput.value = state[settingsKey].url || '';\r\n        if (keyInput) keyInput.value = state[settingsKey].key || '';\r\n        if (tempInput) tempInput.value = state[settingsKey].temperature || 0.7;\r\n        if (tempValue) tempValue.textContent = state[settingsKey].temperature || 0.7;\r\n        \r\n        // 模型下拉框可能需要重新拉取才能显示正确，这里只能先设置值，如果option不存在则显示为空\r\n        if (modelSelect && state[settingsKey].model) {\r\n            // 如果下拉框里没有这个模型，添加一个临时的\r\n            if (!modelSelect.querySelector(`option[value=\"${state[settingsKey].model}\"]`)) {\r\n                const option = document.createElement('option');\r\n                option.value = state[settingsKey].model;\r\n                option.textContent = state[settingsKey].model;\r\n                modelSelect.appendChild(option);\r\n            }\r\n            modelSelect.value = state[settingsKey].model;\r\n        }\r\n    }\r\n\r\n    // --- 数据管理 ---\r\n\r\n    function saveConfig() {\r\n        try {\r\n            localStorage.setItem('iphoneSimConfig', JSON.stringify(state));\r\n        } catch (e) {\r\n            alert('存储空间不足，无法保存所有数据（可能是图片太大）。建议减少壁纸或图标数量。');\r\n            console.error(e);\r\n        }\r\n    }\r\n\r\n    function loadConfig() {\r\n        const saved = localStorage.getItem('iphoneSimConfig');\r\n        if (saved) {\r\n            try {\r\n                const loadedState = JSON.parse(saved);\r\n                Object.assign(state, loadedState);\r\n                \r\n                // 确保预设数组存在\r\n                if (!state.fontPresets) state.fontPresets = [];\r\n                if (!state.cssPresets) state.cssPresets = [];\r\n                if (!state.aiSettings) state.aiSettings = { url: '', key: '', model: '', temperature: 0.7 };\r\n                if (!state.aiPresets) state.aiPresets = [];\r\n                if (!state.aiSettings2) state.aiSettings2 = { url: '', key: '', model: '', temperature: 0.7 };\r\n                if (!state.aiPresets2) state.aiPresets2 = [];\r\n                if (!state.contacts) state.contacts = [];\r\n                if (!state.chatHistory) state.chatHistory = {};\r\n                if (!state.worldbook) state.worldbook = [];\r\n                if (!state.userPersonas) state.userPersonas = [];\r\n                if (!state.moments) state.moments = [];\r\n                \r\n                const cssEditor = document.getElementById('css-editor');\r\n                if (cssEditor) cssEditor.value = state.css;\r\n                \r\n                applyFont(state.currentFont);\r\n                applyWallpaper(state.currentWallpaper);\r\n                applyIcons();\r\n                applyCSS(state.css);\r\n                \r\n                renderFontPresets();\r\n                renderCssPresets();\r\n                renderAiPresets();\r\n                renderAiPresets(true);\r\n                updateAiUi();\r\n                updateAiUi(true);\r\n                renderContactList();\r\n                renderWorldbookList();\r\n                renderMeTab();\r\n                renderMoments();\r\n            } catch (e) {\r\n                console.error('解析配置失败:', e);\r\n            }\r\n        }\r\n    }\r\n\r\n    function exportJSON() {\r\n        const blob = new Blob([JSON.stringify(state)], { type: 'application/json' });\r\n        const url = URL.createObjectURL(blob);\r\n        const a = document.createElement('a');\r\n        a.href = url;\r\n        a.download = 'iphone-sim-config.json';\r\n        a.click();\r\n        URL.revokeObjectURL(url);\r\n    }\r\n\r\n    function importJSON(e) {\r\n        const file = e.target.files[0];\r\n        if (!file) return;\r\n\r\n        const reader = new FileReader();\r\n        reader.onload = (event) => {\r\n            try {\r\n                const loadedState = JSON.parse(event.target.result);\r\n                Object.assign(state, loadedState);\r\n                \r\n                // 确保预设数组存在\r\n                if (!state.fontPresets) state.fontPresets = [];\r\n                if (!state.cssPresets) state.cssPresets = [];\r\n                if (!state.aiSettings) state.aiSettings = { url: '', key: '', model: '', temperature: 0.7 };\r\n                if (!state.aiPresets) state.aiPresets = [];\r\n                if (!state.aiSettings2) state.aiSettings2 = { url: '', key: '', model: '', temperature: 0.7 };\r\n                if (!state.aiPresets2) state.aiPresets2 = [];\r\n                if (!state.contacts) state.contacts = [];\r\n                if (!state.chatHistory) state.chatHistory = {};\r\n                if (!state.worldbook) state.worldbook = [];\r\n                if (!state.userPersonas) state.userPersonas = [];\r\n                if (!state.moments) state.moments = [];\r\n                \r\n                const cssEditor = document.getElementById('css-editor');\r\n                if (cssEditor) cssEditor.value = state.css;\r\n                \r\n                applyFont(state.currentFont);\r\n                applyWallpaper(state.currentWallpaper);\r\n                applyIcons();\r\n                applyCSS(state.css);\r\n                renderWallpaperGallery();\r\n                renderIconSettings();\r\n                renderFontPresets();\r\n                renderCssPresets();\r\n                renderAiPresets();\r\n                renderAiPresets(true);\r\n                updateAiUi();\r\n                updateAiUi(true);\r\n                renderContactList();\r\n                renderWorldbookList();\r\n                renderMeTab();\r\n                renderMoments();\r\n                \r\n                saveConfig();\r\n                alert('配置导入成功');\r\n            } catch (err) {\r\n                alert('配置文件格式错误');\r\n                console.error(err);\r\n            }\r\n        };\r\n        reader.readAsText(file);\r\n    }\r\n});\r\n<\/script>\n\n\n</body></html>"};
            const ENTRY = "小手机/index.html";
            const frame = document.getElementById('app-frame');

            function navigate(path) {
                console.log('Navigating to:', path);
                if (!VFS[path]) {
                    alert('页面不存在: ' + path);
                    return;
                }
                frame.srcdoc = VFS[path];
            }
            window.addEventListener('message', function(event) {
                const data = event.data;
                if (data && data.type === 'navigate' && data.path) {
                    navigate(data.path);
                } else if (data && data.type === 'download') {
                    // 外层处理下载请求
                    const { content, filename } = data;
                    const blob = new Blob([content], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                    console.log('外层已触发下载：' + filename);
                }
            });

            navigate(ENTRY);
        })();
    </script>
</body>
</html>